<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Team Leader Order View</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/@tailwindcss/ui@0.7.2/dist/tailwind-ui.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">


  <style>
  html, body {
  height: 100%;
  overflow: auto; /* ✅ allow scroll */
}


  body {
    display: flex;
  }

  .fade-in {
    animation: fadeIn 0.4s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .sidebar {
    width: 260px;
    background: #1c1c1e;
    color: white;
    padding: 2rem 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    position: fixed;
    height: 100%;
    z-index: 10;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }

  .sidebar h3 {
    font-size: 1.5rem;
    margin-bottom: 2rem;
  }

  .sidebar a {
    font-size: 1rem;
    color: white;
    text-decoration: none;
    padding: 8px 0;
    transition: all 0.2s ease;
  }

  .sidebar a:hover {
    color: #0a84ff;
  }

 .main-content {
  flex: 1;
  margin-left: 260px;
  padding: 2rem;
  overflow-x: hidden;
  background: #f2f2f7;
}


  h2 {
    font-size: 1.75rem;
    font-weight: 600;
    color: #0a84ff;
    margin-bottom: 1rem;
  }

  #statusMsg {
    font-size: 1rem;
    color: #444;
    margin-bottom: 1rem;
    text-align: center;
  }

  header {
    background: #fff;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  header button {
    padding: 8px 14px;
    border: none;
    border-radius: 8px;
    font-size: 0.95rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: transform 0.2s ease, background 0.2s ease;
  }

  header button:hover {
    transform: scale(1.05);
  }

  .table-container {
  overflow-y: auto;
  overflow-x: auto;
  border-radius: 12px;
  background: white;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  max-height: 70vh; /* required for scroll */
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  position: relative;
}



  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
    table-layout: fixed;
  }


  th, td {
    padding: 12px 14px;
    border: 1px solid #e5e5ea;
    text-align: left;
    word-wrap: break-word;
    white-space: normal;
  }

thead th {
  position: sticky;
  top: 0;
  background-color: #007aff;
  color: white;
  font-weight: 600;
  z-index: 10;
  padding: 12px 14px;
  text-align: left;
  user-select: none;
  border-bottom: 1px solid #ccc;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}



  tr:nth-child(even) {
    background-color: #f9f9f9;
  }

 

  th.resizable::after {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    width: 5px;
    height: 100%;
    cursor: col-resize;
    z-index: 2;
  }

  #customizePanel {
    display: none;
    background: white;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-radius: 12px;
    margin-bottom: 1.5rem;
    max-width: 100%;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
  }


.chart-slide-panel {
  transform: translateX(-100%);
  max-height: 0;
  overflow: hidden;
  transition: transform 0.5s ease, max-height 0.5s ease;
  will-change: transform, max-height;
}


.chart-slide-panel.visible {
  transform: translateX(0%);
  max-height: 2000px; /* ✅ INCREASED HEIGHT */
}






/* 🧠 Keep your original styles here first */

/* ✅ ADD: Responsive Sidebar & Header Layout */
@media (max-width: 768px) {
  .sidebar {
    position: absolute;
    width: 100%;
    height: auto;
    flex-direction: row;
    justify-content: space-around;
    padding: 1rem;
    top: 0;
    z-index: 99;
  }

  .main-content {
    margin-left: 0;
    padding-top: 6rem; /* pushes content below the mobile sidebar */
  }

  header {
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
  }

  .table-container {
    max-height: 60vh; /* reduce on smaller screens */
  }
}

/* ✅ ADD: Mac-style scrollbars */
.table-container::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

.table-container::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 10px;
}

/* ✅ ADD: Smooth sticky header shadow effect */
thead th {
  transition: box-shadow 0.3s ease;
}

.table-container:has(thead th.sticky) thead th {
  box-shadow: 0 4px 6px rgba(0,0,0,0.08);
}


#buyerFilterPanel {
  animation: fadeIn 0.3s ease-in;
}


///chart
options: {
  responsive: true,
  maintainAspectRatio: false,
  interaction: {
    mode: 'index',
    intersect: false
  },
  animation: {
    duration: 1000,
    easing: 'easeOutCubic'
  },
  scales: {
    x: {
      stacked: true,
      title: {
        display: true,
        text: 'Suppliers',
        font: { size: 14, weight: 'bold' }
      },
      ticks: {
        font: { size: 12 },
        color: '#333'
      }
    },
    y: {
      stacked: true,
      beginAtZero: true,
      title: {
        display: true,
        text: 'Number of Orders',
        font: { size: 14, weight: 'bold' }
      },
      ticks: {
        stepSize: 1,
        font: { size: 12 },
        color: '#333'
      }
    }
  },
  plugins: {
    legend: {
      position: 'bottom',
      labels: {
        font: { size: 13, family: 'Segoe UI, sans-serif' },
        boxWidth: 16,
        padding: 15
      }
    },
    tooltip: {
      backgroundColor: '#1c1c1e',
      titleFont: { size: 13 },
      bodyFont: { size: 13 },
      padding: 10,
      cornerRadius: 8,
      callbacks: {
        label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}`
      }
    }
  }
}





</style>

<!-- Sidebar -->
<aside class="sidebar">
  <h3>📊 Dashboard</h3>
  <a href="#">🏠 Home</a>
  <a href="#" onclick="showChartSection()">📈 Charts</a>
  <a href="#" onclick="generateStatusReport()">📄 Reports</a>

  <a href="#" onclick="showBuyerFilterPanel()">👥 Purchasers</a>
  <a href="#" onclick="logout()" class="text-red-400 hover:text-red-500">🚪 Logout</a>
</aside>

<!-- Page Content -->
<div class="main-content fade-in">
  <!-- Top Header -->
  <header>
    <h2>📋 Team Leader Control Panel</h2>
    <div class="flex gap-3">
      <button id="btnCustomize" class="bg-[#007aff] text-white">⚙️ Customize</button>
      <button onclick="refreshTable()" class="bg-[#34c759] text-white">🔄 Refresh</button>
      <button onclick="exportTableToCSV()" class="bg-[#ff9500] text-white">📤 Export CSV</button>
    </div>
  </header>

  <!-- Customize Panel -->
  <div id="customizePanel" class="hidden bg-white rounded-xl shadow-md p-6 mb-6 animate-fade-in-down">
    <div class="flex items-center justify-between mb-4">
      <h4 class="text-xl font-semibold text-gray-800 flex items-center gap-2">🛠️ Table Settings</h4>
    </div>
    <div id="customizeColumns" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      <!-- JS will populate columns here -->
    </div>
  </div>




<div id="buyerFilterPanel" style="display: none; background:white; padding: 1rem; margin-bottom: 1rem; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
  <strong>Filter by Buyer:</strong>
  <div id="buyerCheckboxes" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 0.5rem;"></div>
</div>



<!-- Chart Slide Panel -->
<div id="chartSlidePanel"
     class="chart-slide-panel transform transition-transform duration-500 ease-in-out bg-gray-50 rounded-xl shadow-inner p-6">
  <div class="mb-6 flex justify-between items-center">
    <h4 class="text-xl font-semibold text-gray-800 tracking-tight">📊 Order Insights</h4>
  </div>

  <div class="flex flex-wrap justify-center gap-6">
    <!-- Pie Chart Card -->
    <div class="w-full xl:w-1/3 md:w-1/2" style="max-width: 550px; height: 400px;">
      <div class="bg-white rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 p-5 h-full">
        <h5 class="text-md font-semibold text-gray-700 mb-3">🧩 Orders by Main Category</h5>
        <div class="flex items-center justify-center h-full">
          <canvas id="categoryPieChart" style="min-height: 300px; min-width: 300px;"></canvas>
        </div>
      </div>
    </div>

    <!-- Line Chart Card -->
    <div class="w-full xl:w-1/3 md:w-1/2" style="max-width: 550px; height: 400px;">
      <div class="bg-white rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 p-5 h-full">
        <h5 class="text-md font-semibold text-gray-700 mb-3">📈 Orders Over Time</h5>
        <div class="flex items-center justify-center h-full">
          <canvas id="ordersLineChart" style="min-height: 300px; min-width: 300px;"></canvas>
        </div>
      </div>
    </div>


  <!-- Delivery Status per Supplier Card -->
<div class="w-full xl:w-1/3 md:w-full" style="max-width: 550px; height: 400px;">
  <div class="bg-white rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 p-5 h-full flex flex-col justify-between">
    <!-- Header and Selectors -->
    <div class="mb-3">
      <h5 class="text-md font-semibold text-gray-700 mb-3">📦 Delivery Status per Supplier</h5>
      <div class="flex flex-wrap gap-2">
        <div class="flex items-center gap-2">
          <label for="supplierSelect" class="text-sm font-medium text-gray-600">Supplier:</label>
          <select id="supplierSelect"
                  class="text-sm border border-gray-300 rounded-xl px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="all">All Suppliers</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <label for="sortSelect" class="text-sm font-medium text-gray-600">Sort:</label>
          <select id="sortSelect"
                  class="text-sm border border-gray-300 rounded-xl px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="alphabetical">Alphabetical (A-Z)</option>
            <option value="total">Total Orders (desc)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Chart -->
    <div class="overflow-x-auto rounded-xl border border-gray-100 bg-gray-50 p-2">
      <div style="min-width: 400px; min-height: 280px;">
        <canvas id="supplierStatusChart" class="w-full" style="height: 280px !important;"></canvas>
      </div>
    </div>
  </div>
</div>


  </div>
</div>





<!-- Table Container -->
  <div class="table-container">
    <table id="ordersTable">
      <thead id="ordersHead">
        <tr><th>Loading...</th></tr>
      </thead>
      <tbody id="ordersBody">
        <tr><td>Loading orders...</td></tr>
      </tbody>
    </table>
  </div>



  <!-- Status Message -->
  <div id="statusMsg">🔐 Verifying user...</div>







  <!-- Footer -->
  <footer class="mt-8 text-center text-gray-400 text-sm">
    © 2025 Team Leader Dashboard. All rights reserved.
  </footer>
</div>




<!-- Reports Modal -->
<div id="reportModal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-start justify-center overflow-y-auto pt-10 pb-10">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-5xl flex flex-col p-6 relative">
    <button onclick="closeReportModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-500 text-2xl">&times;</button>
    <h3 id="reportTitle" class="text-xl font-semibold mb-4">📊 Report</h3>

<div class="flex flex-wrap justify-between gap-3 mb-4">
  <!-- On Time -->
  <div class="status-btn bg-green-100 hover:bg-green-200 p-4 rounded cursor-pointer w-[calc(25%-0.75rem)] min-w-[200px]" data-status="On Time">
    <h4 class="text-lg font-semibold">🟢 On Time (<span id="onTimeCount">0</span>)</h4>
    <p class="text-sm text-gray-600">Orders delivered on or before target date</p>
  </div>

  <!-- Delayed -->
  <div class="status-btn bg-yellow-100 hover:bg-yellow-200 p-4 rounded cursor-pointer w-[calc(25%-0.75rem)] min-w-[200px]" data-status="Delayed">
    <h4 class="text-lg font-semibold">🟡 Delayed (<span id="delayedCount">0</span>)</h4>
    <p class="text-sm text-gray-600">Orders delivered after target date</p>
  </div>

  <!-- Invalid -->
  <div class="status-btn bg-red-100 hover:bg-red-200 p-4 rounded cursor-pointer w-[calc(25%-0.75rem)] min-w-[200px]" data-status="Invalid">
    <h4 class="text-lg font-semibold">🔴 Invalid (<span id="invalidCount">0</span>)</h4>
    <p class="text-sm text-gray-600">Orders with invalid or missing data</p>
  </div>

  <!-- In Progress -->
  <div class="status-btn bg-blue-100 hover:bg-blue-200 p-4 rounded cursor-pointer w-[calc(25%-0.75rem)] min-w-[200px]" data-status="In Progress">
    <h4 class="text-lg font-semibold">🔵 In Progress (<span id="inProgressCount">0</span>)</h4>
    <p class="text-sm text-gray-600">Orders not delivered and overdue</p>
  </div>
</div>


    <!-- Table -->
    <div class="overflow-auto max-h-[60vh]">
      <table class="w-full text-sm text-left border">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="px-3 py-2 border">Order No</th>
	    <th class="px-3 py-2 border">Supplier</th>
            <th class="px-3 py-2 border">Delivery Date</th>
            <th class="px-3 py-2 border">Tentative Date</th>
            <th class="px-3 py-2 border">Approved Date</th>
            <th class="px-3 py-2 border">Remarks</th>
          </tr>
        </thead>
        <tbody id="delayedOrdersTableBody">
          <!-- JavaScript will populate this -->
        </tbody>
      </table>
    </div>
  </div>
</div>














<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD9LCzMuEGIiRQrOVCgH6d-jxxJLZ0QBCk",
    authDomain: "order-monitoring-purchasing.firebaseapp.com",
    projectId: "order-monitoring-purchasing",
    storageBucket: "order-monitoring-purchasing.appspot.com",
    messagingSenderId: "209378598320",
    appId: "1:209378598320:web:0c143d69bc329a994d8a75"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let columnSettings = { visible: [], order: [], widths: {} };
  let chartPanelVisible = false;
  let ordersChartInstance = null;
  let categoryChartInstance = null;
  let supplierStatusChartInstance = null;
  let chartsRendered = false;

window.supplierChartRendered = false;


  function loadColumnSettings(defaultColumns) {
    const saved = JSON.parse(localStorage.getItem("tableColumnSettings"));
    if (saved && Array.isArray(saved.order) && Array.isArray(saved.visible)) {
      columnSettings = {
        visible: saved.visible,
        order: saved.order,
        widths: saved.widths || {}
      };
    } else {
      columnSettings = {
        visible: [...defaultColumns],
        order: [...defaultColumns],
        widths: {}
      };
    }
  }


function showBuyerFilterPanel() {
  const panel = document.getElementById('buyerFilterPanel');
  panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none';
}




















function formatDateDisplay(dateStr) {
  const date = new Date(dateStr);
  if (isNaN(date.getTime())) return '';
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}











function showChartSection() {
  const panel = document.getElementById("chartSlidePanel");
  chartPanelVisible = !chartPanelVisible;

  if (chartPanelVisible) {
    panel.classList.add("visible");
    if (!chartsRendered && window.latestOrderData) {
      renderOrdersChart(window.latestOrderData);
      renderCategoryPieChart(window.latestOrderData);
      chartsRendered = true;
    }
  } else {
    panel.classList.remove("visible");
  }
}





function renderOrdersChart(orderData) {
  const ctx = document.getElementById('ordersLineChart').getContext('2d');
  if (ordersChartInstance) ordersChartInstance.destroy();

  const monthlyCounts = {};
  orderData.forEach(order => {
    const date = new Date(order.orderDate || order.order?.['Order Date']);
    if (!isNaN(date)) {
      const monthKey = date.toLocaleString('default', { month: 'short', year: 'numeric' });
      monthlyCounts[monthKey] = (monthlyCounts[monthKey] || 0) + 1;
    }
  });

  const labels = Object.keys(monthlyCounts);
  const values = Object.values(monthlyCounts);

  ordersChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Orders',
        data: values,
        borderColor: '#0a84ff',
        backgroundColor: 'rgba(10,132,255,0.1)',
        tension: 0.3,
        fill: true,
        pointRadius: 5,
        pointBackgroundColor: '#0a84ff'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `Orders: ${ctx.parsed.y}`
          }
        }
      },
      scales: {
        x: { title: { display: true, text: 'Month' } },
        y: { beginAtZero: true, title: { display: true, text: 'Number of Orders' } }
      }
    }
  });
}




function renderCategoryPieChart(orderData) {
  const ctx = document.getElementById('categoryPieChart').getContext('2d');
  if (categoryChartInstance) categoryChartInstance.destroy();

  const categoryCounts = {};

  orderData.forEach(order => {
    const rawCategory = order.order?.Category || "";
    const mainCategory = rawCategory.split('.')[0].trim().toUpperCase();

    if (mainCategory) {
      categoryCounts[mainCategory] = (categoryCounts[mainCategory] || 0) + 1;
    }
  });

  const labels = Object.keys(categoryCounts);
  const data = Object.values(categoryCounts);
  const backgroundColors = labels.map((_, i) =>
    `hsl(${(i * 137.5) % 360}, 70%, 60%)`);

  categoryChartInstance = new Chart(ctx, {
    type: 'pie',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: backgroundColors
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.label}: ${ctx.parsed} orders`
          }
        }
      }
    }
  });
}


function renderSupplierStatusChart() {
  if (!window.latestOrderData) return;

  const supplierMap = {};

  // Initialize all suppliers
  window.latestOrderData.forEach(row => {
    const supplier = row.order?.Supplier || "Unknown";
    if (!supplierMap[supplier]) {
      supplierMap[supplier] = {
        "On Time": 0,
        "Delayed": 0,
        "Invalid": 0,
        "In Progress": 0
      };
    }
  });

  // Count per category
  window.onTimeOrders.forEach(o => supplierMap[o.supplier]["On Time"]++);
  window.delayedOrders.forEach(o => supplierMap[o.supplier]["Delayed"]++);
  window.invalidOrders.forEach(o => supplierMap[o.supplier]["Invalid"]++);
  window.inProgressOrders.forEach(o => supplierMap[o.supplier]["In Progress"]++);

  const suppliers = Object.keys(supplierMap);
  const onTimeData = suppliers.map(s => supplierMap[s]["On Time"]);
  const delayedData = suppliers.map(s => supplierMap[s]["Delayed"]);
  const invalidData = suppliers.map(s => supplierMap[s]["Invalid"]);
  const inProgressData = suppliers.map(s => supplierMap[s]["In Progress"]);

  const ctx = document.getElementById('supplierStatusChart').getContext('2d');
  if (supplierStatusChartInstance) supplierStatusChartInstance.destroy();

  supplierStatusChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: suppliers,
      datasets: [
        {
          label: '🟢 On Time',
          data: onTimeData,
          backgroundColor: '#34d399'
        },
        {
          label: '🟡 Delayed',
          data: delayedData,
          backgroundColor: '#facc15'
        },
        {
          label: '🔴 Invalid',
          data: invalidData,
          backgroundColor: '#f87171'
        },
        {
          label: '🔵 In Progress',
          data: inProgressData,
          backgroundColor: '#60a5fa'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          stacked: true,
          title: { display: true, text: 'Suppliers' }
        },
        y: {
          stacked: true,
          beginAtZero: true,
          title: { display: true, text: 'Number of Orders' }
        }
      },
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}`
          }
        }
      }
    }
  });
}

function populateSupplierDropdown(suppliers) {
  const supplierSelect = document.getElementById('supplierSelect');
  supplierSelect.innerHTML = '<option value="all">All Suppliers</option>'; // reset

  suppliers.forEach(supplier => {
    const option = document.createElement('option');
    option.value = supplier;
    option.textContent = supplier;
    supplierSelect.appendChild(option);
  });
}

function getTotalOrdersForSupplier(supplierData) {
  return supplierData["On Time"] + supplierData["Delayed"] + supplierData["Invalid"] + supplierData["In Progress"];
}

function updateSupplierStatusChart(selectedSupplier = "all", sortBy = "alphabetical") {
  if (!window.latestOrderData) return;

  const supplierMap = {};

  // Initialize counts per supplier
  window.latestOrderData.forEach(row => {
    const supplier = row.order?.Supplier || "Unknown";
    if (!supplierMap[supplier]) {
      supplierMap[supplier] = {
        "On Time": 0,
        "Delayed": 0,
        "Invalid": 0,
        "In Progress": 0
      };
    }
  });

  // Fill counts from categorized orders (make sure these globals exist and are correct)
  (window.onTimeOrders || []).forEach(o => {
  if (supplierMap[o.supplier]) supplierMap[o.supplier]["On Time"]++;
});

(window.delayedOrders || []).forEach(o => {
  if (supplierMap[o.supplier]) supplierMap[o.supplier]["Delayed"]++;
});

(window.invalidOrders || []).forEach(o => {
  if (supplierMap[o.supplier]) supplierMap[o.supplier]["Invalid"]++;
});

(window.inProgressOrders || []).forEach(o => {
  if (supplierMap[o.supplier]) supplierMap[o.supplier]["In Progress"]++;
});


  // Filter suppliers if needed
  let suppliers = Object.keys(supplierMap);
  if (selectedSupplier !== "all") {
    suppliers = suppliers.filter(s => s === selectedSupplier);
  }

  // Sort suppliers
  if (sortBy === "alphabetical") {
    suppliers.sort((a, b) => a.localeCompare(b));
  } else if (sortBy === "total") {
    suppliers.sort((a, b) => getTotalOrdersForSupplier(supplierMap[b]) - getTotalOrdersForSupplier(supplierMap[a]));
  }

  // Prepare datasets
  const onTimeData = suppliers.map(s => supplierMap[s]["On Time"]);
  const delayedData = suppliers.map(s => supplierMap[s]["Delayed"]);
  const invalidData = suppliers.map(s => supplierMap[s]["Invalid"]);
  const inProgressData = suppliers.map(s => supplierMap[s]["In Progress"]);

  const ctx = document.getElementById('supplierStatusChart').getContext('2d');
  if (supplierStatusChartInstance) supplierStatusChartInstance.destroy();

  supplierStatusChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: suppliers,
      datasets: [
        {
          label: '🟢 On Time',
          data: onTimeData,
          backgroundColor: 'rgba(52, 211, 153, 0.8)',
          borderRadius: 5
        },
        {
          label: '🟡 Delayed',
          data: delayedData,
          backgroundColor: 'rgba(250, 204, 21, 0.8)',
          borderRadius: 5
        },
        {
          label: '🔴 Invalid',
          data: invalidData,
          backgroundColor: 'rgba(248, 113, 113, 0.8)',
          borderRadius: 5
        },
        {
          label: '🔵 In Progress',
          data: inProgressData,
          backgroundColor: 'rgba(96, 165, 250, 0.8)',
          borderRadius: 5
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          stacked: true,
          title: { display: true, text: 'Suppliers', font: { size: 14, weight: 'bold' } },
          ticks: { font: { size: 12 }, color: '#333' }
        },
        y: {
          stacked: true,
          beginAtZero: true,
          title: { display: true, text: 'Number of Orders', font: { size: 14, weight: 'bold' } },
          ticks: { stepSize: 1, font: { size: 12 }, color: '#333' }
        }
      },
      plugins: {
        legend: { position: 'bottom', labels: { font: { size: 13 }, boxWidth: 16, padding: 15 } },
        tooltip: {
          backgroundColor: '#1c1c1e',
          titleFont: { size: 13 },
          bodyFont: { size: 13 },
          padding: 10,
          cornerRadius: 8,
          callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}` }
        }
      },
      animation: { duration: 800, easing: 'easeOutCubic' },
      interaction: { mode: 'index', intersect: false }
    }
  });
}


// Initialize dropdowns and chart after data loads
function initSupplierChartControls() {
  if (!window.latestOrderData) return;

  const supplierMap = {};
  window.latestOrderData.forEach(row => {
    const supplier = row.order?.Supplier || "Unknown";
    supplierMap[supplier] = true;
  });
  const suppliers = Object.keys(supplierMap).sort();

  populateSupplierDropdown(suppliers);

  // ✅ Render the chart once even if panel not opened yet
  if (!window.supplierChartRendered) {
    updateSupplierStatusChart();
    window.supplierChartRendered = true;
  }

  // Event listeners
  document.getElementById('supplierSelect').addEventListener('change', (e) => {
    const selectedSupplier = e.target.value;
    const sortBy = document.getElementById('sortSelect').value;
    updateSupplierStatusChart(selectedSupplier, sortBy);
  });

  document.getElementById('sortSelect').addEventListener('change', (e) => {
    const sortBy = e.target.value;
    const selectedSupplier = document.getElementById('supplierSelect').value;
    updateSupplierStatusChart(selectedSupplier, sortBy);
  });
}

document.addEventListener("DOMContentLoaded", async () => {
  await fetchAndPrepareOrderData(); // Make sure this initializes all global data
  initSupplierChartControls();      // Only call this AFTER data is ready
});










  function saveColumnSettings() {
    localStorage.setItem("tableColumnSettings", JSON.stringify(columnSettings));
  }

  function fixTableColumnWidths() {
    const head = document.getElementById("ordersHead");
    const body = document.getElementById("ordersBody");
    const headerRow = head.querySelector("tr");
    const rows = Array.from(body.querySelectorAll("tr"));

    if (!headerRow) return;

    columnSettings.order.forEach((col, i) => {
      if (!columnSettings.visible.includes(col)) return;

      let maxWidth = 0;
      const th = headerRow.children[i];
      if (th) maxWidth = Math.max(maxWidth, th.textContent.trim().length * 10);

      rows.forEach(row => {
        const cell = row.children[i];
        if (cell) maxWidth = Math.max(maxWidth, cell.textContent.trim().length * 9);
      });

      maxWidth = Math.max(80, Math.min(maxWidth, 300));

      if (headerRow.children[i]) headerRow.children[i].style.width = maxWidth + "px";
      rows.forEach(row => {
        if (row.children[i]) row.children[i].style.width = maxWidth + "px";
      });

      columnSettings.widths[col] = maxWidth;
    });

    saveColumnSettings();
  }

 function buildTable(rows) {
  const head = document.getElementById("ordersHead");
  const body = document.getElementById("ordersBody");
  head.innerHTML = "";
  body.innerHTML = "";

  if (!rows.length) {
    head.innerHTML = "<tr><th>No Data</th></tr>";
    body.innerHTML = "<tr><td>No orders found</td></tr>";
    return;
  }

  const allColumns = new Set(["userId"]);
  rows.forEach(r => Object.keys(r.order).forEach(k => allColumns.add(k)));
  const allColArray = Array.from(allColumns);

  loadColumnSettings(allColArray);

  // ⬅️ Get and clear the customize panel
  const customizePanel = document.getElementById("customizePanel");
  const customizeColumnsContainer = document.getElementById("customizeColumns");
  customizeColumnsContainer.innerHTML = "";

  // ✅ Auto Fit Button: Insert at top of customizePanel
  let existingAutoFit = document.getElementById("autoFitBtn");
  if (existingAutoFit) existingAutoFit.remove();

  const autoFitBtn = document.createElement("button");
  autoFitBtn.id = "autoFitBtn";
  autoFitBtn.className = "mb-5 flex items-center gap-2 bg-[#d1d1d6] hover:bg-[#c7c7cc] text-[#1c1c1e] px-4 py-2 rounded-lg shadow-sm transition-all duration-200";
  autoFitBtn.innerHTML = `🧩 <span class="font-medium">Auto Fit Column Widths</span> <kbd class="ml-auto bg-white border border-gray-300 px-2 py-0.5 rounded text-xs text-gray-600">Shortcut</kbd>`;
  autoFitBtn.onclick = fixTableColumnWidths;
  customizePanel.insertBefore(autoFitBtn, customizeColumnsContainer);

  // ✅ Column Visibility Checkboxes
  customizeColumnsContainer.style.display = "grid";
  customizeColumnsContainer.style.gridTemplateColumns = "repeat(auto-fill, minmax(180px, 1fr))";
  customizeColumnsContainer.style.gap = "12px";

  columnSettings.order.forEach(col => {
    const wrapper = document.createElement("label");
    wrapper.style.cssText = `
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f2f2f7;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
    `;
    const input = document.createElement("input");
    input.type = "checkbox";
    input.checked = columnSettings.visible.includes(col);
    input.dataset.col = col;
    input.addEventListener("change", () => {
      const colName = input.dataset.col;
      if (input.checked) {
        if (!columnSettings.visible.includes(colName)) {
          columnSettings.visible.push(colName);
        }
      } else {
        columnSettings.visible = columnSettings.visible.filter(c => c !== colName);
      }
      saveColumnSettings();
      buildTable(rows);
    });
    const labelText = document.createElement("span");
    labelText.textContent = col;
    wrapper.appendChild(input);
    wrapper.appendChild(labelText);
    customizeColumnsContainer.appendChild(wrapper);
  });

  // ✅ Table Header
  const headerRow = document.createElement("tr");
  columnSettings.order.forEach(col => {
    if (!columnSettings.visible.includes(col)) return;

const th = document.createElement("th");
th.classList.add("resizable");

th.dataset.col = col;
th.style.userSelect = "none";

    th.style.userSelect = "none";
    if (columnSettings.widths[col]) {
      th.style.width = columnSettings.widths[col] + "px";
    }

    const titleSpan = document.createElement("span");
    titleSpan.textContent = col;
    titleSpan.style.pointerEvents = "none";
    th.appendChild(titleSpan);

    const resizer = document.createElement("div");
    resizer.style.cssText = `
      width: 6px;
      height: 100%;
      position: absolute;
      top: 0;
      right: 0;
      cursor: col-resize;
      z-index: 10;
    `;
    let isResizing = false;

    resizer.addEventListener("mousedown", (e) => {
      e.stopPropagation();
      isResizing = true;
      const startX = e.pageX;
      const startWidth = th.offsetWidth;
      const index = Array.from(headerRow.children).indexOf(th);
      const colName = th.dataset.col;

      function onMouseMove(eMove) {
        const newWidth = startWidth + (eMove.pageX - startX);
        head.querySelectorAll("th")[index].style.width = newWidth + "px";
        body.querySelectorAll("tr").forEach(row => {
          if (row.children[index]) row.children[index].style.width = newWidth + "px";
        });
      }

      function onMouseUp() {
        isResizing = false;
        const newWidth = head.querySelectorAll("th")[index].offsetWidth;
        columnSettings.widths[colName] = newWidth;
        saveColumnSettings();
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("mouseup", onMouseUp);
      }

      document.addEventListener("mousemove", onMouseMove);
      document.addEventListener("mouseup", onMouseUp);
    });

    th.appendChild(resizer);

    // Drag & Drop Columns
    th.draggable = true;
    th.addEventListener("dragstart", e => {
      if (isResizing) {
        e.preventDefault();
        return;
      }
      e.dataTransfer.setData("text/plain", col);
    });
    th.addEventListener("dragover", e => e.preventDefault());
    th.addEventListener("drop", e => {
      e.preventDefault();
      if (isResizing) return;
      const draggedCol = e.dataTransfer.getData("text/plain");
      const targetCol = th.dataset.col;
      const fromIndex = columnSettings.order.indexOf(draggedCol);
      const toIndex = columnSettings.order.indexOf(targetCol);
      columnSettings.order.splice(fromIndex, 1);
      columnSettings.order.splice(toIndex, 0, draggedCol);
      saveColumnSettings();
      buildTable(rows);
    });

    headerRow.appendChild(th);
  });
  head.appendChild(headerRow);

  // ✅ Table Body
  rows.forEach(r => {
    const tr = document.createElement("tr");
    columnSettings.order.forEach(col => {
      if (!columnSettings.visible.includes(col)) return;
      const td = document.createElement("td");

      if (col === "userId") {
  td.textContent = r.userId;
} else if (["Delivery Date", "Order Date", "Approved Date", "Need By Date"].includes(col)) {
  td.textContent = formatDateDisplay(r.order[col]);
} else {
  td.textContent = r.order[col] ?? "";
if (col.toLowerCase() === "buyer") {
  td.classList.add("buyer-cell");
}




}

      if (columnSettings.widths[col]) {
        td.style.width = columnSettings.widths[col] + "px";
      }
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}



 auth.onAuthStateChanged(async user => {
  const status = document.getElementById("statusMsg");
  if (!user) {
    status.textContent = "⛔ Not logged in.";
    return;
  }

  try {
    const userDoc = await db.collection("users").doc(user.uid).get();
    const data = userDoc.data();

    if (!data || (data.role?.toLowerCase() !== "team leader")) {
      status.textContent = "⛔ Access denied. Only Team Leaders allowed.";
      return;
    }

    const assignedUsers = data.teamMembers || [];
    if (assignedUsers.length === 0) {
      status.textContent = "📝 No users assigned to you yet.";
      return;
    }

    const rows = [];
    for (const uid of assignedUsers) {
      const snap = await db.collection("orders").doc(uid).collection("userOrders").get();
      snap.forEach(doc => {
        rows.push({ userId: uid, order: doc.data() });
      });
    }

    document.getElementById("ordersTable").style.display = "table";
    status.style.display = "none";

    buildTable(rows);          // ✅ Build the table
    buildBuyerFilter();        // ✅ Then build the buyer filter
    window.latestOrderData = rows; // Save for chart use
    initSupplierChartControls(); // Initialize supplier chart controls and render chart


    if (!Object.keys(columnSettings.widths).length) {
      fixTableColumnWidths();
    }

  } catch (err) {
    console.error("Error loading orders:", err);
    status.textContent = "❌ Error loading orders.";
    return;
  }
});



  document.getElementById("btnCustomize").addEventListener("click", () => {
    const panel = document.getElementById("customizePanel");
    panel.style.display = panel.style.display === "none" ? "block" : "none";
  });


document.addEventListener('DOMContentLoaded', function () {
  const table = document.querySelector('table');
  const rows = Array.from(table.querySelectorAll('tbody tr'));
  const buyerSet = new Set();

  // Step 1: Collect all unique buyers
  rows.forEach(row => {
    const buyerCell = row.querySelector('.buyer-cell');
    if (buyerCell) buyerSet.add(buyerCell.innerText.trim());
  });

  const buyerList = Array.from(buyerSet).sort();
  const checkboxContainer = document.getElementById('buyerCheckboxes');

  // Step 2: Generate checkboxes
  buyerList.forEach(buyer => {
    const label = document.createElement('label');
    label.style.marginRight = '15px';
    label.innerHTML = `
      <input type="checkbox" class="buyer-filter" value="${buyer}" checked />
      ${buyer}
    `;
    checkboxContainer.appendChild(label);
  });

  // Step 3: Filter table based on checkbox selection
  document.querySelectorAll('.buyer-filter').forEach(checkbox => {
    checkbox.addEventListener('change', filterRows);
  });

  function filterRows() {
    const checkedBuyers = Array.from(document.querySelectorAll('.buyer-filter:checked')).map(cb => cb.value);

    rows.forEach(row => {
      const buyerCell = row.querySelector('.buyer-cell');
      if (buyerCell) {
        const buyerName = buyerCell.innerText.trim();
        row.style.display = checkedBuyers.includes(buyerName) ? '' : 'none';
      }
    });
  }
});


function buildBuyerFilter() {
  const checkboxContainer = document.getElementById('buyerCheckboxes');
  checkboxContainer.innerHTML = ""; // clear previous

  const allRows = document.querySelectorAll('#ordersBody tr');
  const buyerSet = new Set();

  allRows.forEach(row => {
    const buyerCell = row.querySelector('.buyer-cell');
    if (buyerCell) buyerSet.add(buyerCell.innerText.trim());
  });

  const buyerList = Array.from(buyerSet).sort();
  buyerList.forEach(buyer => {
    const label = document.createElement('label');
    label.style.marginRight = '15px';
    label.innerHTML = `
      <input type="checkbox" class="buyer-filter" value="${buyer}" checked />
      ${buyer}
    `;
    checkboxContainer.appendChild(label);
  });

  // Add event listeners
  document.querySelectorAll('.buyer-filter').forEach(checkbox => {
    checkbox.addEventListener('change', () => {
      const selected = Array.from(document.querySelectorAll('.buyer-filter:checked')).map(cb => cb.value);
      document.querySelectorAll('#ordersBody tr').forEach(row => {
        const buyerCell = row.querySelector('.buyer-cell');
        if (!buyerCell) return;
        row.style.display = selected.includes(buyerCell.innerText.trim()) ? "" : "none";
      });
    });
  });
}










document.addEventListener('click', function (e) {
  const buyerPanel = document.getElementById('buyerFilterPanel');
  const customizePanel = document.getElementById('customizePanel');
  const usersBtn = document.querySelector('a[onclick*="showBuyerFilterPanel"]');
  const customizeBtn = document.getElementById('btnCustomize');

  const clickedInsideBuyer = buyerPanel.contains(e.target) || usersBtn.contains(e.target);
  const clickedInsideCustomize = customizePanel.contains(e.target) || customizeBtn.contains(e.target);

  // If click is outside both panels and their toggle buttons
  if (!clickedInsideBuyer) {
    buyerPanel.style.display = 'none';
  }

  if (!clickedInsideCustomize) {
    customizePanel.style.display = 'none';
  }
});


function showReportModal() {
  document.getElementById("reportModal").classList.remove("hidden");
}


function closeReportModal() {
  document.getElementById("reportModal").classList.add("hidden");
}




function generateStatusReport() {
  console.log("🚀 generateStatusReport called");
  const data = window.latestOrderData;
  if (!data || !data.length) {
    alert("No order data available.");
    return;
  }

  const today = new Date();
  let onTime = 0, delayed = 0, invalid = 0, inProgress = 0;
  let onTimeRows = [], delayedRows = [], invalidRows = [], inProgressRows = [];

  const formatDate = (raw) => {
    const date = new Date(raw);
    return raw && !isNaN(date)
      ? date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
      : "—";
  };

  data.forEach(row => {
    const order = row.order;
    const deliveryDateRaw = order["Delivery Date"];
    const approvedDateRaw = order["Approved Date"];
    const tentativeDateRaw = order["Tentative Delivery Date"];

    const deliveryDate = deliveryDateRaw ? new Date(deliveryDateRaw) : null;
    const approvedDate = approvedDateRaw ? new Date(approvedDateRaw) : null;
    const tentativeDate = tentativeDateRaw ? new Date(tentativeDateRaw) : null;

    if (!tentativeDate) return;

    const baseDetails = {
      orderNo: order["Number"] || "N/A",
      supplier: order["Supplier"] || "—",
      deliveryDate: formatDate(deliveryDateRaw),
      approvedDate: formatDate(approvedDateRaw),
      tentativeDate: formatDate(tentativeDateRaw)
    };

    if (deliveryDate && approvedDate && deliveryDate < approvedDate) {
      invalid++;
      invalidRows.push({ ...baseDetails, remarks: "Invalid (Delivery before Approval)" });
      return;
    }

    if (deliveryDate && deliveryDate <= tentativeDate) {
      onTime++;
      onTimeRows.push({ ...baseDetails, remarks: "On Time" });
      return;
    }

    if (deliveryDate && deliveryDate > tentativeDate) {
      delayed++;
      delayedRows.push({ ...baseDetails, remarks: "Delayed" });
    } else if (!deliveryDate && today > tentativeDate) {
      inProgress++;
      inProgressRows.push({ ...baseDetails, remarks: "Not Delivered (Overdue)" });
    }
  });

  // 🌐 Store in global variables
  window.onTimeOrders = onTimeRows;
  window.delayedOrders = delayedRows;
  window.invalidOrders = invalidRows;
  window.inProgressOrders = inProgressRows;

 // 🆕 ✅ Render the new chart here
  renderSupplierStatusChart();


  // 🧮 Update UI counters
  document.getElementById("onTimeCount").textContent = onTime;
  document.getElementById("delayedCount").textContent = delayed;
  document.getElementById("invalidCount").textContent = invalid;
  document.getElementById("inProgressCount").textContent = inProgress;

  // 📊 Show Delayed by default
  renderStatusTable("Delayed", delayedRows);

 auth.onAuthStateChanged(user => {
  if (!user) return;

  const reportData = {
    timestamp: Date.now(),
    onTimeOrders: window.onTimeOrders,
    delayedOrders: window.delayedOrders,
    invalidOrders: window.invalidOrders,
    inProgressOrders: window.inProgressOrders
  };

  saveReportsToFirestore(user.uid, reportData);
});

}



async function saveReportsToFirestore(userId, reportData) {
  const reportRef = db.collection("reports").doc(userId).collection("statusReports").doc("latest");

  try {
    const existing = await reportRef.get();
    const existingData = existing.exists ? existing.data() : null;

    // Check if the report data is different
    const hasChanged = !existingData || JSON.stringify(existingData) !== JSON.stringify(reportData);

    if (hasChanged) {
      await reportRef.set(reportData, { merge: true });
      console.log("✅ Reports saved to Firestore.");
    } else {
      console.log("ℹ️ No changes in report data. Skipped saving.");
    }
  } catch (err) {
    console.error("❌ Error saving report:", err);
  }
}


























function renderStatusTable(title, rows) {
  const tbody = document.getElementById("delayedOrdersTableBody");
  tbody.innerHTML = "";

  if (rows.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-2">No ${title} orders found.</td></tr>`;
  } else {
    rows.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="px-3 py-1 border">${item.orderNo}</td>
        <td class="px-3 py-1 border">${item.supplier || '-'}</td>
        <td class="px-3 py-1 border">${item.deliveryDate}</td>
        <td class="px-3 py-1 border">${item.tentativeDate}</td>
        <td class="px-3 py-1 border">${item.approvedDate}</td>
        <td class="px-3 py-1 border text-red-600">${item.remarks}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  document.getElementById("reportTitle").textContent = `📊 ${title} Orders`;
  showReportModal();
}




// 🖱️ Click events on count sections to filter table
document.getElementById("onTimeCount").addEventListener("click", () => {
  renderStatusTable("On Time", window.onTimeOrders);
});
document.getElementById("delayedCount").addEventListener("click", () => {
  renderStatusTable("Delayed", window.delayedOrders);
});
document.getElementById("invalidCount").addEventListener("click", () => {
  renderStatusTable("Invalid", window.invalidOrders);
});
document.getElementById("inProgressCount").addEventListener("click", () => {
  renderStatusTable("In Progress", window.inProgressOrders);
});





// 🖱️ Handle click events for status buttons
document.querySelectorAll('.status-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const selectedStatus = btn.getAttribute('data-status');

    // 🔄 Highlight active
    document.querySelectorAll('.status-btn').forEach(b => {
      b.classList.remove('bg-blue-500', 'text-white', 'ring', 'ring-offset-2');
    });
    btn.classList.add('bg-blue-500', 'text-white', 'ring', 'ring-offset-2');

    // 🎯 Select dataset based on clicked status
    switch (selectedStatus) {
      case 'On Time':
        renderStatusTable('On Time', window.onTimeOrders);
        break;
      case 'Delayed':
        renderStatusTable('Delayed', window.delayedOrders);
        break;
      case 'Invalid':
        renderStatusTable('Invalid', window.invalidOrders);
        break;
      case 'In Progress':
        renderStatusTable('In Progress', window.inProgressOrders);
        break;
      default:
        break;
    }
  });
});





document.addEventListener("DOMContentLoaded", () => {
  const reportLink = document.getElementById("reportLink");
  if (reportLink) {
    reportLink.addEventListener("click", (e) => {
      e.preventDefault();
      generateStatusReport(); // this will call showReportModal()
    });
  } else {
    console.error("❌ reportLink not found in DOM");
  }
});









  function logout() {
    auth.signOut().then(() => {
      window.location.href = "Loginindex.html";
    });
  }
</script>


</body>
</html>
