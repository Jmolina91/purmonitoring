<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Team Leader Order View</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/@tailwindcss/ui@0.7.2/dist/tailwind-ui.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>


  <style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #f2f2f7;
    overflow: hidden;
  }

  body {
    display: flex;
  }

  .fade-in {
    animation: fadeIn 0.4s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .sidebar {
    width: 260px;
    background: #1c1c1e;
    color: white;
    padding: 2rem 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    position: fixed;
    height: 100%;
    z-index: 10;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }

  .sidebar h3 {
    font-size: 1.5rem;
    margin-bottom: 2rem;
  }

  .sidebar a {
    font-size: 1rem;
    color: white;
    text-decoration: none;
    padding: 8px 0;
    transition: all 0.2s ease;
  }

  .sidebar a:hover {
    color: #0a84ff;
  }

 .main-content {
  flex: 1;
  margin-left: 260px;
  padding: 2rem;
  overflow-x: hidden;
  background: #f2f2f7;
}


  h2 {
    font-size: 1.75rem;
    font-weight: 600;
    color: #0a84ff;
    margin-bottom: 1rem;
  }

  #statusMsg {
    font-size: 1rem;
    color: #444;
    margin-bottom: 1rem;
    text-align: center;
  }

  header {
    background: #fff;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  header button {
    padding: 8px 14px;
    border: none;
    border-radius: 8px;
    font-size: 0.95rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: transform 0.2s ease, background 0.2s ease;
  }

  header button:hover {
    transform: scale(1.05);
  }

 .table-container {
  overflow: auto;
  border-radius: 12px;
  background: white;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  max-height: 70vh;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  padding: 0;
  position: relative;
}

/* Sticky header */
#ordersTable thead th {
  position: sticky;
  top: 0;
  background-color: #007aff;
  color: white;
  z-index: 10;
  font-weight: 600;
  border-bottom: 1px solid #ccc;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
    table-layout: fixed;
  }

table thead th {
  position: sticky;
  top: 0;
  background-color: #007aff; /* match header background */
  color: white;
  z-index: 5;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* subtle shadow */
}

  th, td {
    padding: 12px 14px;
    border: 1px solid #e5e5ea;
    text-align: left;
    word-wrap: break-word;
    white-space: normal;
  }

thead th {
  position: sticky;
  top: 0;
  background-color: #007aff; /* Required! */
  color: white;
  font-weight: 600;
  z-index: 10;
  padding: 12px 14px;
  text-align: left;
  user-select: none;
  border-bottom: 1px solid #ccc;
}



  th {
    background-color: #007aff;
    color: white;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
    user-select: none;
  }

  tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  th.resizable {
    position: relative;
  }

  th.resizable::after {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    width: 5px;
    height: 100%;
    cursor: col-resize;
    z-index: 2;
  }

  #customizePanel {
    display: none;
    background: white;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-radius: 12px;
    margin-bottom: 1.5rem;
    max-width: 100%;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
  }


.chart-slide-panel {
  width: 100%;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  max-height: 0;
  overflow: hidden;
  transform: translateX(-100%); /* start fully hidden */
  position: relative;
  z-index: 1;
  margin-top: 1rem;
  transition: transform 0.5s ease-in-out, max-height 0.5s ease-in-out;
}

.chart-slide-panel.visible {
  transform: translateX(0%);
  max-height: 600px; /* adjust if needed based on chart height */
}


#buyerFilterButtons {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 1rem;
}



</style>

<!-- Sidebar -->
<aside class="sidebar">
  <h3>üìä Dashboard</h3>
  <a href="#">üè† Home</a>
  <a href="#" onclick="showChartSection()">üìà Charts</a>

  <a href="#">üìÑ Reports</a>
  <a href="#">üë• Users</a>
  <a href="#" onclick="logout()" class="text-red-400 hover:text-red-500">üö™ Logout</a>
</aside>

<!-- Page Content -->
<div class="main-content fade-in">
  <!-- Top Header -->
  <header>
  <h2>üìã Team Leader Orders</h2>
  <div class="flex gap-3 flex-wrap">
    <button id="btnCustomize" type="button" class="bg-blue-500 hover:bg-blue-600 text-white font-medium px-4 py-2 rounded-lg transition-all">
      ‚öôÔ∏è Customize
    </button>

    <button onclick="refreshTable()" type="button" class="bg-green-500 hover:bg-green-600 text-white font-medium px-4 py-2 rounded-lg transition-all">
      üîÑ Refresh
    </button>
    <button class="text-black bg-[#ff9500]" onclick="exportTableToExcel('ordersTable', 'Order_Report')">üì§ Export Excel</button>
    </button>
  </div>
</header>


  <!-- Customize Panel -->
  <div id="customizePanel" class="hidden bg-white rounded-xl shadow-md p-6 mb-6 animate-fade-in-down">
    <div class="flex items-center justify-between mb-4">
      <h4 class="text-xl font-semibold text-gray-800 flex items-center gap-2">üõ†Ô∏è Table Settings</h4>
    </div>
    <div id="customizeColumns" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      <!-- JS will populate columns here -->
    </div>
  </div>


<!-- Use a simple toggle for visibility of the filter dropdown -->
<div class="relative inline-block">
  <button id="buyerFilterBtn" class="bg-white text-sm border rounded px-3 py-1">
    Filter Buyer ‚è∑
  </button>

  <!-- This dropdown should always be visible or appear when the button is clicked -->
  <select id="buyerFilterSelect" class="absolute mt-1 w-full border rounded bg-white shadow-md hidden z-10">
    <option value="">All Buyers</option>
    <!-- Options will be added via JS -->
  </select>
</div>





<!-- Chart Slide Panel -->
<div id="chartSlidePanel"
     class="chart-slide-panel transform transition-transform duration-500 ease-in-out">
  <div class="p-6">

    <!-- Section Title -->
    <div class="flex justify-between items-center mb-4">
      <h4 class="text-lg font-semibold text-gray-700">üìä Order Insights</h4>
    </div>

    <!-- Chart Area -->
    <div class="w-full mt-6 max-w-[800px] mx-auto">
      <h5 class="text-md font-semibold text-gray-600 mb-2">‚è±Ô∏è Monthly On Time vs Delayed Orders (%)</h5>
      
<div class="w-full" style="height: 300px;">
  <canvas id="onTimeDelayedChart" width="800" height="300" class="w-full h-full"></canvas>
</div>


    </div>

  </div>
</div>



<!-- Status Message -->
<div id="statusMsg">üîê Verifying user...</div>


<!-- Search Navigation -->
<div class="flex justify-end items-center px-6 py-4">
  <input 
    type="text" 
    id="searchInput" 
    placeholder="üîç Search orders..." 
    class="px-4 py-2 border rounded-md shadow-sm w-full max-w-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
  />
</div>


<!-- Table Container -->
<div class="table-container">
  <table id="ordersTable">
    <thead id="ordersHead">
      <tr><th>Loading...</th></tr>
    </thead>
    <tbody id="ordersBody">
      <tr><td>Loading orders...</td></tr>
    </tbody>
  </table>
</div>









<!-- Bigger Modal Loader -->
<div id="loaderModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.5); z-index: 9999; pointer-events: auto;">
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 80%; max-width: 600px; background: white; padding: 40px; border-radius: 16px;
    box-shadow: 0 6px 30px rgba(0, 0, 0, 0.25); text-align: center;">
    
    <div id="loaderLabel" style="margin-bottom: 20px; font-weight: bold; font-size: 1.8rem;">Sorting... 0%</div>
    
    <div style="width: 100%; background: #ddd; height: 30px; border-radius: 15px; overflow: hidden;">
      <div id="loaderBar" style="height: 100%; width: 0%; background: linear-gradient(to right, #007bff, #00d4ff); transition: width 0.1s;"></div>
    </div>
    
  </div>
</div>





  <!-- Footer -->
  <footer class="mt-8 text-center text-gray-400 text-sm">
    ¬© 2025 Team Leader Dashboard. All rights reserved.
  </footer>
</div>






<script> 
  const firebaseConfig = {
    apiKey: "AIzaSyD9LCzMuEGIiRQrOVCgH6d-jxxJLZ0QBCk",
    authDomain: "order-monitoring-purchasing.firebaseapp.com",
    projectId: "order-monitoring-purchasing",
    storageBucket: "order-monitoring-purchasing.appspot.com",
    messagingSenderId: "209378598320",
    appId: "1:209378598320:web:0c143d69bc329a994d8a75"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();




  let columnSettings = { visible: [], order: [], widths: {} };
  let chartPanelVisible = false;
  let ordersChartInstance = null;
  let categoryChartInstance = null;
  let supplierStatusChartInstance = null;
  let chartsRendered = false;
  

const buyerFilterDropdown = document.getElementById("buyerFilterDropdown");
const buyerFilterBtn = document.getElementById("buyerFilterBtn");




window.supplierChartRendered = false;


  function loadColumnSettings(defaultColumns) {
    const saved = JSON.parse(localStorage.getItem("tableColumnSettings"));
    if (saved && Array.isArray(saved.order) && Array.isArray(saved.visible)) {
      columnSettings = {
        visible: saved.visible,
        order: saved.order,
        widths: saved.widths || {}
      };
    } else {
      columnSettings = {
        visible: [...defaultColumns],
        order: [...defaultColumns],
        widths: {}
      };
    }
  }

let selectedBuyers = []; // Placeholder if needed in future

async function loadOrders() {
  try {
    const data = await fetchDataFromDatabase();

    populateTable(data);

    // Wait a short delay to ensure table renders
    setTimeout(() => {
      renderOnTimeVsDelayedChart();
    }, 100); // Delay just enough for DOM update

    buildBuyerFilter(); // Build after table is populated
  } catch (error) {
    console.error('Error loading orders:', error);
  }
}

// Build the Buyer filter dropdown options
function buildBuyerFilter() {
  const buyerIndex = getBuyerColumnIndex();
  const rows = document.querySelectorAll("#ordersBody tr");
  const buyersSet = new Set();

  rows.forEach(row => {
    const cells = row.querySelectorAll("td");
    const buyer = cells[buyerIndex]?.textContent.trim();
    if (buyer) buyersSet.add(buyer);
  });

  const select = document.getElementById("buyerFilterSelect");
  select.innerHTML = `<option value="">All Buyers</option>`; // Value = "" is important

  Array.from(buyersSet).sort().forEach(buyer => {
    const option = document.createElement("option");
    option.value = buyer;
    option.textContent = buyer;
    select.appendChild(option);
  });
}

// Filter table rows by selected buyer
function filterTable(selectedBuyer) {
  const buyerIndex = getBuyerColumnIndex();
  const rows = document.querySelectorAll('#ordersBody tr');

  rows.forEach(row => {
    const cells = row.querySelectorAll("td");
    const buyer = buyerIndex !== -1 ? cells[buyerIndex]?.textContent.trim() : "";

    // ‚úÖ Show all rows when "All Buyers" is selected (value is "")
    if (selectedBuyer === "" || buyer === selectedBuyer) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });
}

// Get column index of "Buyer"
function getBuyerColumnIndex() {
  const headerCells = document.querySelectorAll("#ordersHead th");
  for (let i = 0; i < headerCells.length; i++) {
    if (headerCells[i].dataset.col?.toLowerCase() === "buyer") return i;
  }
  return -1;
}

// Toggle Buyer Filter dropdown
document.getElementById("buyerFilterBtn").addEventListener("click", () => {
  const select = document.getElementById("buyerFilterSelect");
  buildBuyerFilter(); // Refresh list in case table changed
  select.classList.toggle("hidden");
});

// On Buyer Select Change
document.getElementById("buyerFilterSelect").addEventListener("change", event => {
  const selectedBuyer = event.target.value;
  filterTable(selectedBuyer);
});

// Load everything on page init
loadOrders();







function formatDateDisplay(dateStr) {
  const date = new Date(dateStr);
  if (isNaN(date.getTime())) return '';
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}







function showChartSection() {
  const panel = document.getElementById("chartSlidePanel");
  chartPanelVisible = !chartPanelVisible;

  if (chartPanelVisible) {
    panel.classList.add("visible");
    renderOnTimeVsDelayedChart(); // ‚¨ÖÔ∏è Always call, not conditional anymore
  } else {
    panel.classList.remove("visible");
  }
}


function renderOnTimeVsDelayedChart() {
  const tbody = document.getElementById('ordersBody');
  if (!tbody) return console.warn("‚ö†Ô∏è No table body found for chart rendering.");

  const rows = tbody.querySelectorAll('tr');
  if (rows.length === 0) return console.warn("‚ö†Ô∏è No table rows found.");

  const headerCells = Array.from(document.querySelectorAll('#ordersHead th'));
  const columnIndex = { number: -1, status: -1, deliveryDate: -1 };

  headerCells.forEach((th, index) => {
    const text = th.innerText.trim().toLowerCase();
    if (text === 'number') columnIndex.number = index;
    if (text === 'status') columnIndex.status = index;
    if (text === 'delivery date') columnIndex.deliveryDate = index;
  });

  if (columnIndex.number === -1 || columnIndex.status === -1 || columnIndex.deliveryDate === -1) {
    console.error("‚ùå Could not find Number, Status, or Delivery Date columns.");
    return;
  }

  const monthlyStats = {};
  const totalPerMonth = {};

  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    const orderNumber = cells[columnIndex.number]?.innerText.trim();
    const status = cells[columnIndex.status]?.innerText.trim().toLowerCase();
    const deliveryText = cells[columnIndex.deliveryDate]?.innerText.trim();
    if (!orderNumber) return;

    const deliveryDate = new Date(deliveryText);
    if (isNaN(deliveryDate)) return;

    const monthYear = deliveryDate.toLocaleString('default', { month: 'long', year: 'numeric' });

    if (!monthlyStats[monthYear]) {
      monthlyStats[monthYear] = {
        onTime: new Set(),
        delayed: new Set(),
        pending: new Set(),
        partial: new Set(),
        cancelled: new Set()
      };
    }

    const map = monthlyStats[monthYear];
    if (status.includes('on time')) map.onTime.add(orderNumber);
    else if (status.includes('delayed')) map.delayed.add(orderNumber);
    else if (status.includes('pending')) map.pending.add(orderNumber);
    else if (status.includes('partially delivered') || status.includes('partial')) map.partial.add(orderNumber);
    else if (status.includes('cancelled') || status.includes('canceled')) map.cancelled.add(orderNumber);
  });

  const labels = Object.keys(monthlyStats);
  const statusTypes = ['onTime', 'delayed', 'pending', 'partial', 'cancelled'];
  const statusColors = {
    onTime: 'rgba(34, 197, 94, 0.7)',
    delayed: 'rgba(239, 68, 68, 0.7)',
    pending: 'rgba(234, 179, 8, 0.7)',
    partial: 'rgba(59, 130, 246, 0.7)',
    cancelled: 'rgba(107, 114, 128, 0.7)'
  };

  const datasets = statusTypes.map(type => {
    const data = [];
    const countData = [];

    labels.forEach(month => {
      const statusSet = monthlyStats[month][type];
      const totalSet = new Set();
      statusTypes.forEach(t => monthlyStats[month][t].forEach(num => totalSet.add(num)));

      const total = totalSet.size || 1;
      const count = statusSet.size;

      data.push(((count / total) * 100).toFixed(1));
      countData.push(count);

      totalPerMonth[month] = totalSet.size; // Store total orders per month
    });

    return {
      label: `${type.charAt(0).toUpperCase()}${type.slice(1).replace('partial', 'Partially Delivered')}`,
      data,
      countData,
      backgroundColor: statusColors[type],
      borderRadius: 8,
      barPercentage: 0.5
    };
  });

  if (labels.length === 0) {
    labels.push("No Data");
    datasets.forEach(ds => {
      ds.data = [0];
      ds.countData = [0];
    });
  }

  const ctx = document.getElementById('onTimeDelayedChart').getContext('2d');

  if (window.onTimeDelayedChart && typeof window.onTimeDelayedChart.destroy === 'function') {
    window.onTimeDelayedChart.destroy();
  }

  window.onTimeDelayedChart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const label = ctx.dataset.label;
              const percent = ctx.formattedValue;
              const count = ctx.dataset.countData?.[ctx.dataIndex] || 0;
              return `${label}: ${count} orders (${percent}%)`;
            }
          }
        },
      datalabels: {
  anchor: 'end',
  align: 'top',
  color: '#111',
  font: {
    weight: 'bold',
    size: 11
  },
  formatter: (percent, ctx) => {
    const count = ctx.dataset.countData?.[ctx.dataIndex];
    if (!count || percent === '0.0') return null;
    return `${count} (${percent}%)`;
  }
}
,
        totalLabels: {
          display: true
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: {
            display: true,
            text: 'Percentage (%)'
          }
        }
      }
    },
    plugins: [
      ChartDataLabels,
      {
        id: 'totalOrderLabel',
        afterDatasetsDraw(chart) {
          const { ctx, chartArea: { top }, scales: { x }, data } = chart;
          ctx.save();
          ctx.font = 'bold 12px Arial';
          ctx.fillStyle = '#000';
          ctx.textAlign = 'center';

          data.labels.forEach((label, index) => {
            const total = totalPerMonth[label] || 0;
            const xCenter = x.getPixelForTick(index);
            ctx.fillText(`Total: ${total}`, xCenter, top + 12);
          });

          ctx.restore();
        }
      }
    ]
  });
}








  function saveColumnSettings() {
    localStorage.setItem("tableColumnSettings", JSON.stringify(columnSettings));
  }

  function fixTableColumnWidths() {
    const head = document.getElementById("ordersHead");
    const body = document.getElementById("ordersBody");
    const headerRow = head.querySelector("tr");
    const rows = Array.from(body.querySelectorAll("tr"));

    if (!headerRow) return;

    columnSettings.order.forEach((col, i) => {
      if (!columnSettings.visible.includes(col)) return;

      let maxWidth = 0;
      const th = headerRow.children[i];
      if (th) maxWidth = Math.max(maxWidth, th.textContent.trim().length * 10);

      rows.forEach(row => {
        const cell = row.children[i];
        if (cell) maxWidth = Math.max(maxWidth, cell.textContent.trim().length * 9);
      });

      maxWidth = Math.max(80, Math.min(maxWidth, 300));

      if (headerRow.children[i]) headerRow.children[i].style.width = maxWidth + "px";
      rows.forEach(row => {
        if (row.children[i]) row.children[i].style.width = maxWidth + "px";
      });

      columnSettings.widths[col] = maxWidth;
    });

    saveColumnSettings();
  }

 function buildTable(rows) {
  const head = document.getElementById("ordersHead");
  const body = document.getElementById("ordersBody");
  head.innerHTML = "";
  body.innerHTML = "";

  if (!rows.length) {
    head.innerHTML = "<tr><th>No Data</th></tr>";
    body.innerHTML = "<tr><td>No orders found</td></tr>";
    return;
  }

  const allColumns = new Set(["userId"]);
  rows.forEach(r => Object.keys(r.order).forEach(k => allColumns.add(k)));
  const allColArray = Array.from(allColumns);

  loadColumnSettings(allColArray);

  // ‚¨ÖÔ∏è Get and clear the customize panel
  const customizePanel = document.getElementById("customizePanel");
  const customizeColumnsContainer = document.getElementById("customizeColumns");
  customizeColumnsContainer.innerHTML = "";

  // ‚úÖ Auto Fit Button: Insert at top of customizePanel
  let existingAutoFit = document.getElementById("autoFitBtn");
  if (existingAutoFit) existingAutoFit.remove();

  const autoFitBtn = document.createElement("button");
  autoFitBtn.id = "autoFitBtn";
  autoFitBtn.className = "mb-5 flex items-center gap-2 bg-[#d1d1d6] hover:bg-[#c7c7cc] text-[#1c1c1e] px-4 py-2 rounded-lg shadow-sm transition-all duration-200";
  autoFitBtn.innerHTML = `üß© <span class="font-medium">Auto Fit Column Widths</span> <kbd class="ml-auto bg-white border border-gray-300 px-2 py-0.5 rounded text-xs text-gray-600">Shortcut</kbd>`;
  autoFitBtn.onclick = fixTableColumnWidths;
  customizePanel.insertBefore(autoFitBtn, customizeColumnsContainer);

  // ‚úÖ Column Visibility Checkboxes
  customizeColumnsContainer.style.display = "grid";
  customizeColumnsContainer.style.gridTemplateColumns = "repeat(auto-fill, minmax(180px, 1fr))";
  customizeColumnsContainer.style.gap = "12px";

  columnSettings.order.forEach(col => {
    const wrapper = document.createElement("label");
    wrapper.style.cssText = `
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f2f2f7;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
    `;
    const input = document.createElement("input");
    input.type = "checkbox";
    input.checked = columnSettings.visible.includes(col);
    input.dataset.col = col;
    input.addEventListener("change", () => {
      const colName = input.dataset.col;
      if (input.checked) {
        if (!columnSettings.visible.includes(colName)) {
          columnSettings.visible.push(colName);
        }
      } else {
        columnSettings.visible = columnSettings.visible.filter(c => c !== colName);
      }
      saveColumnSettings();
      buildTable(rows);
    });
    const labelText = document.createElement("span");
    labelText.textContent = col;
    wrapper.appendChild(input);
    wrapper.appendChild(labelText);
    customizeColumnsContainer.appendChild(wrapper);
  });

  // ‚úÖ Table Header
  const headerRow = document.createElement("tr");
  columnSettings.order.forEach(col => {
    if (!columnSettings.visible.includes(col)) return;

const th = document.createElement("th");
th.classList.add("resizable");

th.dataset.col = col;
th.style.userSelect = "none";

    th.style.userSelect = "none";
    if (columnSettings.widths[col]) {
      th.style.width = columnSettings.widths[col] + "px";
    }

    const titleSpan = document.createElement("span");
    titleSpan.textContent = col;
    titleSpan.style.pointerEvents = "none";
    th.appendChild(titleSpan);

    const resizer = document.createElement("div");
    resizer.style.cssText = `
      width: 6px;
      height: 100%;
      position: absolute;
      top: 0;
      right: 0;
      cursor: col-resize;
      z-index: 10;
    `;
    let isResizing = false;

    resizer.addEventListener("mousedown", (e) => {
      e.stopPropagation();
      isResizing = true;
      const startX = e.pageX;
      const startWidth = th.offsetWidth;
      const index = Array.from(headerRow.children).indexOf(th);
      const colName = th.dataset.col;

      function onMouseMove(eMove) {
        const newWidth = startWidth + (eMove.pageX - startX);
        head.querySelectorAll("th")[index].style.width = newWidth + "px";
        body.querySelectorAll("tr").forEach(row => {
          if (row.children[index]) row.children[index].style.width = newWidth + "px";
        });
      }

      function onMouseUp() {
        isResizing = false;
        const newWidth = head.querySelectorAll("th")[index].offsetWidth;
        columnSettings.widths[colName] = newWidth;
        saveColumnSettings();
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("mouseup", onMouseUp);
      }

      document.addEventListener("mousemove", onMouseMove);
      document.addEventListener("mouseup", onMouseUp);
    });

    th.appendChild(resizer);

    // Drag & Drop Columns
    th.draggable = true;
    th.addEventListener("dragstart", e => {
      if (isResizing) {
        e.preventDefault();
        return;
      }
      e.dataTransfer.setData("text/plain", col);
    });
    th.addEventListener("dragover", e => e.preventDefault());
    th.addEventListener("drop", e => {
      e.preventDefault();
      if (isResizing) return;
      const draggedCol = e.dataTransfer.getData("text/plain");
      const targetCol = th.dataset.col;
      const fromIndex = columnSettings.order.indexOf(draggedCol);
      const toIndex = columnSettings.order.indexOf(targetCol);
      columnSettings.order.splice(fromIndex, 1);
      columnSettings.order.splice(toIndex, 0, draggedCol);
      saveColumnSettings();
      buildTable(rows);
    });

    headerRow.appendChild(th);
  });
  head.appendChild(headerRow);

  // ‚úÖ Table Body
  rows.forEach(r => {
    const tr = document.createElement("tr");
    columnSettings.order.forEach(col => {
      if (!columnSettings.visible.includes(col)) return;
      const td = document.createElement("td");

      if (col === "userId") {
  td.textContent = r.userId;
} else if (["Delivery Date", "Order Date", "Approved Date", "Need By Date"].includes(col)) {
  td.textContent = formatDateDisplay(r.order[col]);
} else {

  td.textContent = r.order[col] ?? "";
if (col.toLowerCase() === "buyer") {
  td.classList.add("buyer-cell");
}




}

    if (columnSettings.widths[col]) {
  td.style.width = columnSettings.widths[col] + "px";
}
tr.appendChild(td);
});
body.appendChild(tr);
});

// ‚úÖ After building the table, update the on-time vs delayed chart
setTimeout(() => {
  renderOnTimeVsDelayedChart();
}, 200);

}





 auth.onAuthStateChanged(async user => {
  const status = document.getElementById("statusMsg");
  if (!user) {
    status.textContent = "‚õî Not logged in.";
    return;
  }

  try {
    const userDoc = await db.collection("users").doc(user.uid).get();
    const data = userDoc.data();

    if (!data || (data.role?.toLowerCase() !== "team leader")) {
      status.textContent = "‚õî Access denied. Only Team Leaders allowed.";
      return;
    }

    const assignedUsers = data.teamMembers || [];
    if (assignedUsers.length === 0) {
      status.textContent = "üìù No users assigned to you yet.";
      return;
    }

    const rows = [];
    for (const uid of assignedUsers) {
      const snap = await db.collection("orders").doc(uid).collection("userOrders").get();
      snap.forEach(doc => {
        rows.push({ userId: uid, order: doc.data() });
      });
    }

    document.getElementById("ordersTable").style.display = "table";
    status.style.display = "none";

    buildTable(rows);          // ‚úÖ Build the table
    window.latestOrderData = rows; // Save for chart use
    initSupplierChartControls(); // Initialize supplier chart controls and render chart


    if (!Object.keys(columnSettings.widths).length) {
      fixTableColumnWidths();
    }

  } catch (err) {
    console.error("Error loading orders:", err);
    status.textContent = "‚ùå Error loading orders.";
    return;
  }
});



  document.getElementById("btnCustomize").addEventListener("click", () => {
    const panel = document.getElementById("customizePanel");
    panel.style.display = panel.style.display === "none" ? "block" : "none";
  });





document.addEventListener('click', function (e) {
  const buyerPanel = document.getElementById('buyerFilterPanel');
  const customizePanel = document.getElementById('customizePanel');
  const usersBtn = document.querySelector('a[onclick*="showBuyerFilterPanel"]');
  const customizeBtn = document.getElementById('btnCustomize');

  const clickedInsideBuyer = buyerPanel.contains(e.target) || usersBtn.contains(e.target);
  const clickedInsideCustomize = customizePanel.contains(e.target) || customizeBtn.contains(e.target);

  // If click is outside both panels and their toggle buttons
  if (!clickedInsideBuyer) {
    buyerPanel.style.display = 'none';
  }

  if (!clickedInsideCustomize) {
    customizePanel.style.display = 'none';
  }
});


function showReportModal() {
  document.getElementById("reportModal").classList.remove("hidden");
}


function closeReportModal() {
  document.getElementById("reportModal").classList.add("hidden");
}


function exportTableToExcel(tableId, filename = 'excel_data') {
    const table = document.getElementById(tableId);
    if (!table) {
        alert("Table not found!");
        return;
    }

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.table_to_sheet(table);
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

    XLSX.writeFile(wb, `${filename}.xlsx`);
}




async function saveReportsToFirestore(userId, reportData) {
  const reportRef = db.collection("reports").doc(userId).collection("statusReports").doc("latest");

  try {
    const existing = await reportRef.get();
    const existingData = existing.exists ? existing.data() : null;

    // Check if the report data is different
    const hasChanged = !existingData || JSON.stringify(existingData) !== JSON.stringify(reportData);

    if (hasChanged) {
      await reportRef.set(reportData, { merge: true });
      console.log("‚úÖ Reports saved to Firestore.");
    } else {
      console.log("‚ÑπÔ∏è No changes in report data. Skipped saving.");
    }
  } catch (err) {
    console.error("‚ùå Error saving report:", err);
  }
}








  function logout() {
    auth.signOut().then(() => {
      window.location.href = "Loginindex.html";
    });
  }

 document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("searchInput");
    const ordersBody = document.getElementById("ordersBody");

    // Remove previous highlights
    function resetHighlights() {
      Array.from(ordersBody.rows).forEach(row => row.classList.remove("highlight"));
    }

    // Search and highlight all matching rows
    function searchAndHighlight(term) {
      resetHighlights();

      const rows = Array.from(ordersBody.rows);
      const lowerTerm = term.toLowerCase();
      const matches = rows.filter(row => row.textContent.toLowerCase().includes(lowerTerm));

      matches.forEach(row => row.classList.add("highlight"));

      // Scroll to first match if found
      if (matches.length > 0) {
        matches[0].scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }

    // Event listener for input change
    searchInput.addEventListener("input", () => {
      const term = searchInput.value.trim();
      if (term.length >= 2) {
        searchAndHighlight(term);
      } else {
        resetHighlights();
      }
    });

    // Inject highlight style
    const style = document.createElement("style");
    style.innerHTML = `.highlight { background-color: #ffeaa7 !important; }`;
    document.head.appendChild(style);
  });




</script>



</body>
</html>
