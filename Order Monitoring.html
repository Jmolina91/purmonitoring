
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Monitoring Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
  :root {
  --apple-blue: #007aff;
  --sidebar-bg: #f9fafc;
  --sidebar-border: #dce1e6;
  --text-main: #1c1c1e;
  --text-muted: #8e8e93;
  --highlight: #0a84ff;
  --card-bg: #ffffff;
  --card-shadow: rgba(0, 0, 0, 0.06);
  --hover-shadow: rgba(0, 0, 0, 0.1);
  --transition-fast: 0.25s ease;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background-color: #f2f4f8;
  color: var(--text-main);
  margin: 0;
  padding: 0;
  overflow-x: hidden;
}


/* === Apple-Style Sidebar (Fixed to avoid collision with navbar) === */
.sidebar {
  position: fixed;
  top: 56px; /* Leaves space for the navbar */
  left: 0;
  width: 260px;
  height: calc(100vh - 56px); /* Subtract navbar height */
  background: rgba(255, 255, 255, 0.65); /* Glassmorphism */
  backdrop-filter: blur(20px);
  border-right: 1px solid rgba(200, 200, 200, 0.3);
  padding: 2rem 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 1.25rem;
  box-shadow: 2px 0 12px rgba(0, 0, 0, 0.06);
  z-index: 999;
  overflow-y: auto;
}


/* ‚ú® Sidebar Title ‚Äî Improved Readability and Padding */
.sidebar-title {
  font-size: 1.25rem;
  font-weight: 700;
  color: #1c1c1e;
  margin-bottom: 1.5rem;
  letter-spacing: 0.5px;
  padding-left: 2px;
}

/* üö™ Slide-In Sidebar Effect (Apple-like animation) */
.sidebar {
  position: fixed;
  top: 56px; /* height of your navbar */
  left: 0;
  width: 260px;
  height: calc(100vh - 56px); /* full height minus navbar */
  background-color: #fff;
  box-shadow: 2px 0 12px rgba(0, 0, 0, 0.08);
  z-index: 1050;
  overflow-y: auto;
  padding: 1rem;
  border-top-right-radius: 12px;
  transition: transform 0.3s ease, opacity 0.3s ease;
}

/* Hidden (slide-out) */
.sidebar.hidden {
  transform: translateX(-100%);
  opacity: 0;
  pointer-events: none;
}


/* üçé Sidebar Button ‚Äî Apple-style Friendly UI */
.sidebar-btn {
  background: linear-gradient(135deg, #007aff, #0a84ff);
  border: none;
  padding: 0.7rem 1.4rem;
  border-radius: 18px;
  color: #ffffff;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0, 122, 255, 0.15);
  transition: all 0.2s ease-in-out;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  text-align: center;
  white-space: nowrap;
}

.sidebar-btn:hover {
  background: linear-gradient(135deg, #005ecb, #007aff);
  transform: translateY(-2px);
  box-shadow: 0 6px 14px rgba(0, 122, 255, 0.25);
}

.sidebar-btn:active {
  transform: scale(0.98);
  box-shadow: 0 3px 8px rgba(0, 122, 255, 0.2);
}

.sidebar-btn.active {
  background: #004ba0;
  box-shadow: inset 0 0 0 2px #ffffff33;
}


/* üßë‚Äçüíª Optional: Add icons to buttons if needed */
.sidebar-btn::before {
  content: 'üõ†Ô∏è';
  font-size: 1.1rem;
}



/* === Main Content === */
.main-content {
  margin-left: 260px;
  padding: 2rem;
  transition: margin-left var(--transition-fast);
}

/* === Card Summary === */
.card-summary {
  background: var(--card-bg);
  padding: 1.5rem 2rem;
  border-radius: 16px;
  box-shadow: 0 4px 14px var(--card-shadow);
  border-left: 5px solid var(--highlight);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card-summary:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 24px var(--hover-shadow);
}

/* === Upload Zone === */
.upload-zone {
  border: 2px dashed #c7c7cc;
  background-color: #f4f4f7;
  padding: 2rem;
  border-radius: 12px;
  text-align: center;
  color: var(--text-muted);
  transition: all var(--transition-fast);
  cursor: pointer;
}

.upload-zone:hover {
  border-color: var(--highlight);
  color: var(--highlight);
  background-color: #e6f0ff;
}

/* === Table Wrapper === */
.table-wrapper {
  max-height: 500px; /* Set scrollable height */
  overflow-y: auto;
  overflow-x: auto;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 10px 24px rgba(0, 0, 0, 0.06);
  margin-top: 2rem;
  padding: 0;
  border: 1px solid #e0e0e0;
}

/* === Table === */
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  font-size: 0.93rem;
  color: #1c1c1e;
  background: #fff;
}

/* === Table Header === */
/* üçè Apple Card Styling */
.apple-card {
  background: #ffffffcc;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
  overflow: hidden;
  backdrop-filter: blur(20px);
  border: 1px solid #e0e0e5;
  transition: all 0.3s ease;
}

/* Header */
.apple-card-header {
  background: linear-gradient(to right, #007aff, #0a84ff);
  color: white;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  font-size: 1.1rem;
  font-weight: 600;
}

/* Body Padding */
.apple-card-body {
  padding: 0;
}

/* Scrollable Table Container */
.apple-table-wrapper {
  max-height: 600px;
  overflow-y: auto;
  border-radius: 0 0 16px 16px;
  position: relative; /* ‚úÖ add this */
  z-index: 1;          /* ‚úÖ to establish stacking context */
}


/* Table */
.apple-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  min-width: 600px;
  font-size: 0.95rem;
  font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

/* Table Head */
.apple-table thead th {
  position: sticky;
  top: 0;
  background: #f8f9fb;
  font-weight: 600;
  color: #1c1c1e;
  padding: 0.85rem 1.2rem;
  border-bottom: 1px solid #d1d1d6;
  backdrop-filter: blur(12px);
  z-index: 10; /* ‚úÖ make sure this is high */
  white-space: nowrap;
  text-align: left;
}


/* Table Rows */
.apple-table tbody tr:hover {
  background-color: #f2f4f8;
  transition: background-color 0.2s ease;
}

.apple-table td {
  padding: 0.75rem 1.2rem;
  border-bottom: 1px solid #ebedf0;
  color: #2c2c2e;
  background: #fff;
  vertical-align: middle;
  transition: background 0.3s ease;
}

/* Scrollbar (optional styling) */
.apple-table-wrapper::-webkit-scrollbar {
  height: 10px;
  width: 10px;
}
.apple-table-wrapper::-webkit-scrollbar-thumb {
  background: #cfd3d6;
  border-radius: 10px;
}

.apple-table th:first-child,
.apple-table td:first-child {
  position: sticky;
  left: 0;
  background: #f8f9fb;
  z-index: 3;
}


.apple-table thead th:first-child {
  z-index: 11; /* higher than normal header row and left column */
}



/* === Chart Styling === */
.chart-wrapper {
  height: 240px;
}

#chartCanvas,
#ordersIssuedChart {
  width: 100% !important;
  height: 240px !important;
}

/* === Side-by-side Charts === */
.chart-duo {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}

.chart-box {
  flex: 1;
  min-width: 300px;
}

/* Divider */
.chart-divider {
  width: 1px;
  background-color: #e0e0e0;
  margin: 0 10px;
}

@media (max-width: 992px) {
  .chart-duo {
    flex-direction: column;
  }
  .chart-divider {
    display: none;
  }
}

/* === Status Tags (One-Line Badge Style) === */
.status-delivered, .status-cancelled, .status-partial {
  font-weight: 600;
  display: inline-block;
  padding: 2px 10px;
  border-radius: 20px;
  font-size: 0.85rem;
  line-height: 1;
  white-space: nowrap;
}

.status-delivered {
  color: #fff;
  background-color: #34c759;
}

.status-cancelled {
  color: #fff;
  background-color: #ff3b30;
}

.status-partial {
  color: #fff;
  background-color: #ff9500;
}



/* === Fade Animation === */
.fade-in {
  animation: fadeIn 0.5s ease-in-out both;
}

@keyframes fadeIn {
  0% {
    opacity: 0;
    transform: translateY(10px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

.apple-style-btn {
  background: linear-gradient(to bottom, #f2f2f7, #d1d1d6); /* Apple-style gray gradient */
  color: #1c1c1e;
  border: 1px solid #c7c7cc;
  border-radius: 12px;
  padding: 10px 18px;
  font-size: 0.95rem;
  font-weight: 500;
  box-shadow: inset 0 1px 0 #ffffff, 0 2px 4px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease-in-out;
  backdrop-filter: blur(10px);
}

.apple-style-btn:hover {
  background: linear-gradient(to bottom, #e0e0e5, #c7c7cc);
  box-shadow: 0 4px 8px rgba(0,0,0,0.12);
  transform: translateY(-1px);
}

.apple-style-btn:active {
  background: #d1d1d6;
  transform: scale(0.98);
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.15);
}

.apple-logout-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  background: linear-gradient(to bottom, #f2f2f7, #d1d1d6); /* macOS-style gray gradient */
  color: #1c1c1e;
  font-size: 0.95rem;
  font-weight: 500;
  border: 1px solid #c7c7cc;
  border-radius: 12px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

.apple-logout-btn:hover {
  background: linear-gradient(to bottom, #e5e5ea, #c7c7cc);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.apple-logout-btn:active {
  background: linear-gradient(to bottom, #d1d1d6, #a1a1aa);
  transform: translateY(0);
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.apple-logout-btn .icon {
  width: 18px;
  height: 18px;
  stroke: #1c1c1e;
}


/* World-Class Apple-Inspired Table Design */
.apple-style-report-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  font-size: 0.95rem;
  background: rgba(255, 255, 255, 0.75);
  backdrop-filter: blur(6px);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
}

.apple-style-report-table thead th {
  background: linear-gradient(to bottom, #f9f9fb, #e8e8f0);
  color: #1c1c1e;
  font-weight: 600;
  padding: 16px;
  text-align: center;
  border-bottom: 1px solid #d1d1d6;
  letter-spacing: 0.3px;
  font-size: 0.96rem;
}

.apple-style-report-table tbody td {
  padding: 14px 16px;
  text-align: center;
  border-bottom: 1px solid #eaeaf0;
  color: #2c2c2e;
  vertical-align: middle;
  background-color: #ffffff;
  transition: background-color 0.2s ease;
}

.apple-style-report-table tbody tr:nth-child(even) td {
  background-color: #fafafa;
}

.apple-style-report-table tbody tr:hover td {
  background-color: #f2f2f7;
  cursor: pointer;
}

.apple-style-report-table .text-success {
  color: #30d158;
  font-weight: 600;
}

.apple-style-report-table .text-danger {
  color: #ff3b30;
  font-weight: 600;
}

.apple-style-report-table .text-warning {
  color: #ff9f0a;
  font-weight: 600;
}

/* Updated Remarks Column Styling for Full Visibility */
.apple-style-report-table td.remarks-cell {
  text-align: left;
  white-space: pre-wrap;
  word-break: break-word;
  max-width: 100%;
}

/* For resizable column headers */
.resizable-header {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  padding-right: 10px;
}

.resizable-header::after {
  content: '';
  position: absolute;
  right: 0;
  top: 0;
  width: 5px;
  height: 100%;
  cursor: col-resize;
  user-select: none;
}









.apple-footer {
  background: linear-gradient(to top, #f2f2f7, #ffffff);
  padding: 40px 20px 20px;
  font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  color: #1c1c1e;
  border-top: 1px solid #e5e5ea;
  box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.05);
}

.footer-container {
  max-width: 1200px;
  margin: 0 auto;
  text-align: center;
}

.footer-section {
  margin-bottom: 20px;
}

.footer-title {
  font-size: 1.2rem;
  font-weight: 600;
  margin: 0;
}

.footer-subtext {
  font-size: 0.95rem;
  color: #6e6e73;
  margin: 4px 0 0;
}

.footer-links {
  margin: 20px 0;
}

.footer-links a {
  margin: 0 12px;
  font-size: 0.95rem;
  color: #0071e3;
  text-decoration: none;
  transition: color 0.2s ease;
}

.footer-links a:hover {
  color: #004ba0;
}

.footer-copy {
  font-size: 0.85rem;
  color: #8e8e93;
}



</style>


</head>
<body>
 
  <!-- NAVIGATION -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">üì¶ Order Monitor</a>
    <ul class="navbar-nav me-auto">
      <li class="nav-item"><a class="nav-link active" href="#">Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" href="Chart project.html">Charts</a></li>
      <li class="nav-item"><a class="nav-link" href="#" id="toggleSidebar">Update</a></li>

      <li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Generate Report
  </a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="#" id="toFollowUpBtn">üìÑ To Follow-Up Report</a></li>
    <li><a class="dropdown-item" href="#" id="statusReportBtn">üìä Status Report</a></li>
    <li><a class="dropdown-item" href="#" id="deliveryperformanceBtn">üìà Delivery Performance Report</a></li>

  </ul>
</li>

</li>

    </ul>

<!-- MY ACCOUNT DROPDOWN MENU -->
<div class="dropdown ms-auto">
  <button class="btn btn-outline-light dropdown-toggle" type="button" id="myAccountDropdown" data-bs-toggle="dropdown" aria-expanded="false">
    My Account
  </button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="myAccountDropdown">
    <li>
      <span class="dropdown-item-text">
        <strong>Name:</strong><br>
        <span id="userEmailDisplay">Loading...</span>
      </span>
    </li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item text-danger" href="#" id="logoutBtn">Logout</a></li>
  </ul>
</div>

  </div>
</nav>


  <!-- SIDEBAR -->
<div id="functionSidebar" class="sidebar hidden">
  <h5 class="sidebar-title">Functions</h5>
  <button id="btnShowUpdate" class="btn btn-primary sidebar-btn w-100 mb-3">UPDATE ORDER DETAILS</button>
  <button id="btnCustomizeTable" class="btn btn-primary sidebar-btn w-100 mb-3">Customize Table</button>
  <button id="btnCustomizeCharts" class="btn btn-secondary sidebar-btn w-100 mb-3">Customize Charts</button>
    </div>
  




  <!-- MAIN CONTENT -->
  <div id="mainContent" style="margin-left: 270px; padding: 20px;">

   <!-- DASHBOARD SUMMARY -->
<div class="container-fluid p-0 mb-4">
  <div class="row text-center gx-3">
    <div class="col-md-2 mb-3">
      <div class="card card-summary">
        <div class="card-body">
          <h6>Total Orders</h6>
          <h4 id="totalOrders">--</h4>
        </div>
      </div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card card-summary">
        <div class="card-body">
          <h6>Delivered</h6>
          <h4 class="text-success" id="deliveredOrders">--</h4>
        </div>
      </div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card card-summary">
        <div class="card-body">
          <h6>Cancelled</h6>
          <h4 class="text-danger" id="cancelledOrders">--</h4>
        </div>
      </div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card card-summary">
        <div class="card-body">
          <h6>In Progress</h6>
          <h4 class="text-warning" id="partialOrders">--</h4>
        </div>
      </div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card card-summary">
        <div class="card-body">
          <h6>Partially Delivered</h6>
          <h4 class="text-info" id="partiallyDeliveredOrders">--</h4>
        </div>
      </div>
    </div>
  </div>
</div>


    <!-- FILTERS + UPLOAD -->
    <div class="container-fluid p-0 mb-4">
      <div class="row gx-3">
        <div class="col-md-3">
          <input type="text" class="form-control" placeholder="Search Customer/Product..." id="searchInput">
        </div>
        <div class="col-md-3">
          <select class="form-select" id="statusFilter">
            <option value="">All Status</option>
            <option value="Delivered">Delivered</option>
            <option value="Cancelled">Cancelled</option>
            <option value="Partial">Partial</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="upload-zone" for="excelFile">
            üìÅ Click or drag Excel file to upload
            <input type="file" id="excelFile" accept=".xlsx, .xls" hidden>
          </label>



  <button id="btnDownloadExcel" class="apple-style-btn">
    üì• Download Excel
  </button>


        </div>



      </div>
    </div>




<!-- üìä Side-by-Side Charts -->
<div class="container-fluid p-0 mb-4">
  <div class="d-flex flex-wrap justify-content-between chart-duo">

    <!-- Left Chart: Monthly Sales -->
    <div class="chart-box me-md-3 mb-3 mb-md-0">
      <div class="card shadow-sm rounded-4 border-0 h-100">
        <div class="card-body px-4 pt-4 pb-2">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0" style="font-weight: 600; color: #1d1d1f;">üìä Monthly Sales Overview</h5>
            <select id="currencySelector" class="form-select form-select-sm" style="max-width: 150px; border-radius: 12px;">
              <option value="ALL">All Currencies</option>
              <option value="PHP">PHP</option>
              <option value="USD">USD</option>
              <option value="JPY">JPY</option>
            </select>
          </div>
          <div class="chart-wrapper">
            <canvas id="chartCanvas"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Divider Line -->
    <div class="chart-divider d-none d-md-block"></div>

    <!-- Right Chart: Orders Issued -->
    <div class="chart-box ms-md-3">
      <div class="card shadow-sm rounded-4 border-0 h-100">
        <div class="card-body px-4 pt-4 pb-2">
          <h5 class="mb-3" style="font-weight: 600; color: #1d1d1f;">üßæ Total Orders Issued Per Month</h5>
          <div class="chart-wrapper">
            <canvas id="ordersIssuedChart"></canvas>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

















<!-- üçè Apple-Style Order Table -->
<div class="container-fluid p-0 mb-5">
  <div class="apple-card">
    <div class="apple-card-header">
      <h5 class="mb-0">üìã Order List</h5>
    </div>
    <div class="apple-card-body">
      <div class="apple-table-wrapper">
        <table class="apple-table">
          <thead id="orderTableHead" class="sticky-top">
            <!-- JavaScript will insert dynamic headers -->
          </thead>
          <tbody id="orderTableBody">
            <!-- JavaScript will populate rows here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>




  <!-- UPDATE ORDER MODAL -->
  <div class="modal fade" id="updateOrderModal" tabindex="-1" aria-labelledby="updateOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-lg border-0">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title" id="updateOrderModalLabel">
            Update Order <span id="modalOrderNumber" class="text-primary"></span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body pt-0">
          <div id="multiItemContainer">
            <table class="table table-bordered table-hover">
              <thead class="table-light">
                <tr>
                  <th>Product</th>
                  <th>Qty Ordered</th>
                  <th>Qty Delivered</th>
                  <th>Qty Cancelled</th>
                  <th>Unit Price</th>
                  <th>Delivery Date</th>
                  <th>Remarks</th>
                </tr>
              </thead>
              <tbody id="multiItemTableBody">
                <!-- JavaScript will inject rows -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveUpdateBtn" class="btn btn-primary rounded-pill px-4">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CUSTOMIZE TABLE MODAL -->
  <div class="modal fade" id="customizeTableModal" tabindex="-1" aria-labelledby="customizeTableModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="customizeTableModalLabel">Select Columns to Display</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="columnCheckboxContainer">
          <!-- Checkbox list rendered by JS -->
        </div>
        <div class="modal-footer">
          <button type="button" id="confirmColumnsBtn" class="btn btn-success">Apply</button>
          <button type="button" class="btn btn-secondary" onclick="resetColumns()">Reset</button>
        </div>
      </div>
    </div>
  </div>







<!-- Supplier Selection Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-header">
        <h5 class="modal-title" id="reportModalLabel">Select Supplier</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <select id="supplierDropdown" class="form-select mb-3">
          <option value="" disabled selected>Select a supplier</option>
          <!-- Populated by JS -->
        </select>
        <button class="btn btn-primary w-100" id="generateFollowUpReport">Generate Report</button>
      </div>
    </div>
  </div>
</div>






<!-- Report Output Modal -->
<div class="modal fade" id="reportOutputModal" tabindex="-1" aria-labelledby="reportOutputModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header">
        <h5 class="modal-title">
          üìÑ Follow-Up Report for <span id="selectedSupplierName"></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <!-- ‚úÖ Download Button -->
        <div class="d-flex justify-content-end mb-3">
          <button id="downloadFollowUpReport" class="btn btn-outline-success rounded-pill px-4">
            ‚¨áÔ∏è Download Report
          </button>
        </div>

        <!-- ‚úÖ Report Table -->
        <div class="table-responsive">
          <table class="table apple-style-report-table" id="followUpReportTable">
            <thead>
              <tr>
                <th><div class="resizable-header">Order Number</div></th>
                <th><div class="resizable-header">Product</div></th>
         	<th><div class="resizable-header">Unit Price</div></th>
                <th><div class="resizable-header">Qty Ordered</div></th>
                <th><div class="resizable-header">Amount</div></th>
                <th><div class="resizable-header">Qty Delivered</div></th>
                <th><div class="resizable-header">Qty Cancelled</div></th>
                <th><div class="resizable-header">Balance</div></th>
                <th><div class="resizable-header">Need By Date</div></th>
                <th><div class="resizable-header">Remarks</div></th>
              </tr>
            </thead>
            <tbody id="reportTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>







<!-- üìÖ Date Range Modal -->
<div class="modal fade" id="dateRangeModal" tabindex="-1" aria-labelledby="dateRangeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dateRangeModalLabel">Select Date Range</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <label for="startMonth">Start Month:</label>
        <input type="month" id="startMonth" class="form-control mb-2" />

        <label for="endMonth">End Month:</label>
        <input type="month" id="endMonth" class="form-control mb-2" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="confirmDateRangeBtn" class="btn btn-primary">Generate Report</button>
      </div>
    </div>
  </div>
</div>





















<!-- CUSTOMIZE CHART MODAL -->
<div class="modal fade" id="customizeChartModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Customize Chart Types</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label for="chart1Type" class="form-label">Chart 1 (Sales)</label>
        <select id="chart1Type" class="form-select mb-3">
          <option value="line">üìà Line</option>
          <option value="bar">üìä Bar</option>
          <option value="area">üåä Area</option>
        </select>

        <label for="chart2Type" class="form-label">Chart 2 (Orders)</label>
        <select id="chart2Type" class="form-select">
          <option value="bar">üì¶ Bar</option>
          <option value="line">üìà Line</option>
          <option value="area">üåä Area</option>
        </select>
      </div>
      <div class="modal-footer">
        <button id="confirmChartChoices" class="btn btn-primary">Apply</button>
      </div>
    </div>
  </div>
</div>


















<!-- üì¶ Delivery Performance Report Modal -->
<div class="modal fade" id="deliveryPerformanceModal" tabindex="-1" aria-labelledby="deliveryPerformanceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deliveryPerformanceModalLabel">üì¶ Delivery Performance Report</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="deliveryPerformanceContent" class="table-responsive">
          <!-- Report table will be injected here -->
        </div>
      </div>
    </div>
  </div>
</div>



















<footer class="apple-footer">
  <div class="footer-container">
    <div class="footer-section">
      <p class="footer-title">Order Monitoring</p>
      <p class="footer-subtext">Built for performance and simplicity.</p>
    </div>
    <div class="footer-links">
      <a href="#">Privacy</a>
      <a href="#">Terms</a>
      <a href="#">Support</a>
      <a href="#">About</a>
    </div>
    <div class="footer-copy">
      &copy; <span id="currentYear"></span> Hans Technologies. All rights reserved.
    </div>
  </div>
</footer>









</body>



 
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD9LCzMuEGIiRQrOVCgH6d-jxxJLZ0QBCk",
    authDomain: "order-monitoring-purchasing.firebaseapp.com",
    projectId: "order-monitoring-purchasing",
    storageBucket: "order-monitoring-purchasing.appspot.com",
    messagingSenderId: "209378598320",
    appId: "1:209378598320:web:0c143d69bc329a994d8a75",
    measurementId: "G-PPNWT4ECV0"
  };

  firebase.initializeApp(firebaseConfig);
  firebase.analytics();






















  const auth = firebase.auth();
  const firestore = firebase.firestore();

const btnCustomizeTable = document.getElementById('btnCustomizeTable');
const customizeTableModal = new bootstrap.Modal(document.getElementById('customizeTableModal'));
const columnCheckboxContainer = document.getElementById('columnCheckboxContainer');
const confirmColumnsBtn = document.getElementById('confirmColumnsBtn');
const updateNavLink = document.getElementById("toggleSidebar");
















  let inactivityTimer;
  let fullData = [];
  let currentEditingOrderId = '';
  let currentUserId = null; // Use UID for Firestore path
  let chartInstance = null;
  let selectedColumns = [];  // Store which columns are selected
  let draggedColumnIndex = null;
  let ordersChartInstance = null; // Global chart variable
  let fullColumnOrder = [];
  let chart1Type = localStorage.getItem('chart1Type') || 'line';
  let chart2Type = localStorage.getItem('chart2Type') || 'bar';

 document.getElementById("currentYear").textContent = new Date().getFullYear();


const storedSelected = localStorage.getItem('selectedColumns');
if (storedSelected) {
  try {
    selectedColumns = JSON.parse(storedSelected);
  } catch (e) {
    selectedColumns = [];
  }
}

if (selectedColumns.length > 0) {
  // Filter fullColumnOrder to only include saved selectedColumns
  fullColumnOrder = selectedColumns.concat(fullColumnOrder.filter(col => !selectedColumns.includes(col)));
}

















btnCustomizeTable.addEventListener('click', () => {
  columnCheckboxContainer.innerHTML = '';

  const allColumns = fullColumnOrder.length > 0
    ? fullColumnOrder
    : fullData.length > 0
      ? Object.keys(fullData[0])
      : [];

  allColumns.forEach(col => {
    const isChecked = selectedColumns.includes(col);

    const div = document.createElement('div');
    div.className = 'form-check';

    div.innerHTML = `
  <input class="form-check-input" type="checkbox" value="${col}" id="col-${col}" ${isChecked ? 'checked' : ''}>
  <label class="form-check-label" for="col-${col}">${col}</label>
`;


    columnCheckboxContainer.appendChild(div);
  });

  customizeTableModal.show(); // open modal manually
});



















// üëá ADD THIS BLOCK RIGHT AFTER selectedColumns
const storedOrder = localStorage.getItem('fullColumnOrder');
if (storedOrder) {
  try {
    fullColumnOrder = JSON.parse(storedOrder);
  } catch (e) {
    fullColumnOrder = [];
  }
}



confirmColumnsBtn.addEventListener('click', () => {
  const checkboxes = columnCheckboxContainer.querySelectorAll('input[type=checkbox]');
  const checkedCols = Array.from(checkboxes)
                           .filter(cb => cb.checked)
                           .map(cb => cb.value);

  if (checkedCols.length === 0) {
    alert('Select at least one column to display.');
    return;
  }

  selectedColumns = fullColumnOrder.filter(col => checkedCols.includes(col));
  localStorage.setItem('selectedColumns', JSON.stringify(selectedColumns));
  localStorage.setItem('fullColumnOrder', JSON.stringify(fullColumnOrder));

  customizeTableModal.hide();
  populateTable(fullData);
});









function resetColumns() {
  selectedColumns = [];
  fullColumnOrder = [];

  localStorage.removeItem('selectedColumns');
  localStorage.removeItem('fullColumnOrder');

  customizeTableModal.hide();
  populateTable(fullData);
}






document.addEventListener("DOMContentLoaded", () => {
  const updateNavLink = document.getElementById("toggleSidebar");
  const sidebar = document.getElementById("functionSidebar");

  if (updateNavLink && sidebar) {
    updateNavLink.addEventListener("click", (e) => {
      e.preventDefault();
      
      // Toggle slide animation
      sidebar.classList.toggle("translate-x-0");      // Slide in
      sidebar.classList.toggle("translate-x-full");   // Slide out
      sidebar.classList.toggle("hidden");             // Optional if you want full hide
    });
  }
});












auth.onAuthStateChanged(user => {
  if (user) {
    currentUserId = user.uid;

    // Fetch fullName from Firestore compat
    firestore.collection('users')
      .doc(currentUserId)
      .get()
      .then(docSnap => {
        const nameElem = document.getElementById('userEmailDisplay');
        if (nameElem) {
          const data = docSnap.exists && docSnap.data();
          nameElem.textContent = data?.fullName || user.email;
        }
      })
      .catch(err => console.error("Error fetching profile:", err));

    // Then load your orders
    loadOrdersFromFirestore(currentUserId);

  } else {
    window.location.href = "login.html";
  }
});



  document.getElementById('excelFile').addEventListener('change', handleFile, false);
  document.getElementById('searchInput').addEventListener('input', filterTable);
  document.getElementById('statusFilter').addEventListener('change', filterTable);

 async function loadOrdersFromFirestore(userId) {
  try {
    console.log("Loading orders for user:", userId); // ‚úÖ Add this line

    const ordersSnapshot = await firestore
      .collection('orders')
      .doc(userId)
      .collection('userOrders')
      .get();

    fullData = [];
    ordersSnapshot.forEach(doc => {
      const data = doc.data();
      data["docId"] = doc.id;
      fullData.push(data);
    });

    console.log("Loaded fullData:", fullData); // ‚úÖ Log the loaded data

    populateTable(fullData);
    updateSummary(fullData);
    renderCharts(fullData);
  } catch (error) {
    console.error("Error loading user orders:", error);
    fullData = [];
    populateTable(fullData);
    updateSummary(fullData);
  }
}


  function handleFile(e) {
  const file = e.target.files[0];
  if (!file || !currentUserId) return;

  const reader = new FileReader();

  reader.onload = async function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const worksheet = workbook.Sheets[workbook.SheetNames[0]];

    fullData = XLSX.utils.sheet_to_json(worksheet);
    console.log("Excel parsed data:", fullData); // ‚úÖ Log parsed result

    // ‚úÖ Auto-detect and store headers
    if (fullData.length > 0) {
      fullColumnOrder = Object.keys(fullData[0]); // Detect headers from first row
      selectedColumns = [...fullColumnOrder];     // Select all by default

      // ‚úÖ Save selections to localStorage
      localStorage.setItem('fullColumnOrder', JSON.stringify(fullColumnOrder));
      localStorage.setItem('selectedColumns', JSON.stringify(selectedColumns));
    } else {
      alert("Excel is empty or has no valid header row.");
      return;
    }

// ‚úÖ Inject Delivery Date, Lead Time, Tentative Delivery Date
const extraColumns = ["Delivery Date", "Lead Time", "Tentative Delivery Date"];

extraColumns.forEach(col => {
  if (!fullColumnOrder.includes(col)) fullColumnOrder.push(col);
});
extraColumns.forEach(col => {
  if (!selectedColumns.includes(col)) selectedColumns.push(col);
});

// ‚úÖ Save updated columns to localStorage
localStorage.setItem('fullColumnOrder', JSON.stringify(fullColumnOrder));
localStorage.setItem('selectedColumns', JSON.stringify(selectedColumns));



    // ‚úÖ Optional date formatting
    const dateFields = ["Order Date", "Need By Date", "Approved Date", "Order Date raw", "Delivery Date", "Tentative Delivery Date"];
    fullData = fullData.map(row => {
      dateFields.forEach(field => {
        if (row[field]) row[field] = formatDate(row[field]);
      });
      return row;
    });

    try {
      await saveOrdersToFirestore(currentUserId, fullData);
      console.log("Data saved to Firestore.");
      await loadOrdersFromFirestore(currentUserId); // ‚úÖ Reload from Firestore
    } catch (error) {
      console.error("Error saving to Firestore:", error);
    }
  };

  reader.readAsArrayBuffer(file);
}





















const btnShowUpdate = document.getElementById('btnShowUpdate');
const updateOrderModal = new bootstrap.Modal(document.getElementById('updateOrderModal'));
const modalOrderNumber = document.getElementById('modalOrderNumber');
const saveUpdateBtn = document.getElementById('saveUpdateBtn');



// Modify populateTable to respect selectedColumns

function populateTable(data) {
  console.log("üöÄ Populating table with data:", data);

  const tbody = document.getElementById('orderTableBody');
  const thead = document.getElementById('orderTableHead');

  if (!tbody || !thead) {
    console.error("‚ùå Table elements not found.");
    return;
  }

  tbody.innerHTML = '';
  thead.innerHTML = '';

  if (!Array.isArray(data) || data.length === 0) {
    console.warn("‚ö†Ô∏è No data to populate in table.");
    return;
  }

  // ‚úÖ Load or initialize selectedColumns
  if (!Array.isArray(selectedColumns) || selectedColumns.length === 0) {
    const storedSelected = localStorage.getItem('selectedColumns');
    if (storedSelected) {
      try {
        selectedColumns = JSON.parse(storedSelected);
        selectedColumns = selectedColumns.filter(col => Object.keys(data[0]).includes(col));
      } catch (e) {
        selectedColumns = Object.keys(data[0]).filter(key => key);
      }
    } else {
      selectedColumns = Object.keys(data[0]).filter(key => key);
    }
  }

  if (!selectedColumns || selectedColumns.length === 0) {
    selectedColumns = Object.keys(data[0]).filter(key => key);
  }

  const columns = selectedColumns;

  // ‚úÖ Build header
  const headerRow = document.createElement('tr');
  columns.forEach((col) => {
    const th = document.createElement('th');
    th.textContent = col;
    th.setAttribute('draggable', true);
    th.dataset.columnName = col;

    const resizer = document.createElement('div');
    resizer.classList.add('resizer');
    th.appendChild(resizer);

    if (typeof enableResize === 'function') enableResize(th, resizer);

    th.addEventListener('dragstart', handleDragStart);
    th.addEventListener('dragover', handleDragOver);
    th.addEventListener('drop', handleDrop);

    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);

  // ‚úÖ Build rows
  data.forEach(row => {
    const tr = document.createElement('tr');

    columns.forEach(col => {
      const td = document.createElement('td');
      let value = row[col] ?? '';

      // Format object-type values
      if (typeof value === 'object' && value !== null) {
        value = JSON.stringify(value);
      }

      // Handle pricing and amount formatting
      if (col.toLowerCase().includes('price') || col.toLowerCase().includes('amount')) {
        value = Number(value || 0).toFixed(2);
      }

      // Custom rendering logic per column
      if (col === "Lead Time") {
        const select = document.createElement("select");
        select.className = "form-select form-select-sm";
        const options = [
          "Selection", "1-2 Weeks", "2-3 Weeks", "3-4 Weeks", "4-5 Weeks", "5-6 Weeks", "6-7 Weeks",
          "7-8 Weeks", "8-9 Weeks", "9-10 Weeks", "11-12 Weeks", "90-120 Days"
        ];

        options.forEach(option => {
          const opt = document.createElement("option");
          opt.value = option;
          opt.textContent = option;
          if (option === value) opt.selected = true;
          select.appendChild(opt);
        });

        select.addEventListener("change", async () => {
          row["Lead Time"] = select.value;
          row["Tentative Delivery Date"] = computeTentativeDate(row["Approved Date"], select.value);

          // üî• Save to Firestore
          if (row.docId && currentUserId) {
            try {
              await firestore.collection("orders")
                .doc(currentUserId)
                .collection("userOrders")
                .doc(row.docId)
                .update({
                  "Lead Time": row["Lead Time"],
                  "Tentative Delivery Date": row["Tentative Delivery Date"]
                });
              console.log(`‚úÖ Lead Time saved for ${row.docId}`);
            } catch (err) {
              console.error("‚ùå Failed to save Lead Time:", err);
              alert("Failed to save Lead Time.");
            }
          }

          populateTable(fullData); // Refresh table
        });

        td.appendChild(select);

      } else if (col === "Tentative Delivery Date") {
        td.textContent = formatDateDisplay(row["Tentative Delivery Date"]);

      } else if (col.toLowerCase() === "delivery date") {
        td.textContent = formatDateDisplay(row["Delivery Date"]);

      } else if (col.toLowerCase().includes("date")) {
        td.textContent = formatDateDisplay(value);

      } else {
        td.textContent = value;
      }

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  console.log("‚úÖ Table populated with", data.length, "rows.");
}










function handleDragStart(e) {
  draggedColumnName = e.target.dataset.columnName;
  e.dataTransfer.effectAllowed = "move";
}

function handleDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = "move";
}

function handleDrop(e) {
  e.preventDefault();
  const dropColumnName = e.target.closest('th')?.dataset.columnName;
  if (!draggedColumnName || !dropColumnName || draggedColumnName === dropColumnName) return;

  const fromIndex = selectedColumns.indexOf(draggedColumnName);
  const toIndex = selectedColumns.indexOf(dropColumnName);

  if (fromIndex === -1 || toIndex === -1) return;

  const [moved] = selectedColumns.splice(fromIndex, 1);
  selectedColumns.splice(toIndex, 0, moved);

  // Update fullColumnOrder accordingly
  fullColumnOrder = Array.from(new Set(selectedColumns.concat(fullColumnOrder)));


  localStorage.setItem('selectedColumns', JSON.stringify(selectedColumns));
  localStorage.setItem('fullColumnOrder', JSON.stringify(fullColumnOrder));

  populateTable(fullData);
}




function enableResize(th, resizer) {
  let startX, startWidth;

  resizer.addEventListener('mousedown', function (e) {
    startX = e.pageX;
    startWidth = th.offsetWidth;
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
    e.preventDefault();
  });

  function onMouseMove(e) {
    const newWidth = startWidth + (e.pageX - startX);
    th.style.width = newWidth + 'px';
  }

  function onMouseUp() {
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
  }
}










// Form fields inside modal
const updateProduct = document.getElementById('updateProduct');
const updateQtyOrdered = document.getElementById('updateQtyOrdered');
const updateQtyDelivered = document.getElementById('updateQtyDelivered');
const updateQtyCancelled = document.getElementById('updateQtyCancelled');
const updateUnitPrice = document.getElementById('updateUnitPrice');
const updateRemarks = document.getElementById('updateRemarks');

let currentOrderId = null;
let currentItem = null;








btnShowUpdate.addEventListener('click', () => {
  // Ask for Order ID with prompt
  const orderId = prompt("Enter Order ID to update:");
  if (!orderId) {
    alert("No Order ID entered.");
    return;
  }

  // Search order by ID
  const matchingItems = fullData.filter(item => item["Number"] && item["Number"].toString() === orderId);

  if (matchingItems.length === 0) {
    alert("No order found with this ID.");
    return;
  }

  currentOrderId = orderId;
  currentItem = [...matchingItems]; // store full array
modalOrderNumber.textContent = orderId;

// Clear any previous rows in modal
const tableBody = document.getElementById("multiItemTableBody");
tableBody.innerHTML = "";

// Inject a row per item
matchingItems.forEach((item, index) => {
  const row = document.createElement("tr");
 row.innerHTML = `
  <td><input type="text" class="form-control" value="${item["Description"] || ''}" data-field="Description" data-index="${index}" /></td>
  <td><input type="number" class="form-control" value="${item["Quantity Ordered"] || 0}" data-field="Quantity Ordered" data-index="${index}" /></td>
  <td><input type="number" class="form-control" value="${item["Quantity Delivered"] || 0}" data-field="Quantity Delivered" data-index="${index}" /></td>
  <td><input type="number" class="form-control" value="${item["Quantity Cancelled"] || 0}" data-field="Quantity Cancelled" data-index="${index}" /></td>
  <td><input type="number" class="form-control" value="${item["Unit Price"] || 0}" step="0.01" data-field="Unit Price" data-index="${index}" /></td>
  <td><input type="date" class="form-control" value="${item["Delivery Date"] ? formatDateForInput(item["Delivery Date"]) : ''}" data-field="Delivery Date" data-index="${index}" /></td>
  <td><input type="text" class="form-control" value="${item["Remarks"] || ''}" data-field="Remarks" data-index="${index}" /></td>
`;


  tableBody.appendChild(row);
});


  updateOrderModal.show();
});



function formatDateForInput(dateStr) {
  const date = new Date(dateStr);
  if (isNaN(date.getTime())) return '';
  return date.toISOString().split('T')[0]; // YYYY-MM-DD
}









// You can now remove the old btnSearchOrder listener since the search happens on btnShowUpdate

saveUpdateBtn.addEventListener('click', () => {
  if (!currentUserId) {
    alert('User not authenticated');
    return;
  }

  if (!currentOrderId || !currentItem || !Array.isArray(currentItem)) {
    alert('No order loaded');
    return;
  }

  // Loop through each row to gather updated values
  const inputs = document.querySelectorAll('#multiItemTableBody input');
  inputs.forEach(input => {
    const index = parseInt(input.dataset.index);
    const field = input.dataset.field;
    let value = input.value;

    if (["Quantity Ordered", "Quantity Delivered", "Quantity Cancelled", "Unit Price"].includes(field)) {
      value = Number(value) || 0;
    }

    currentItem[index][field] = value;
  });

  // Recalculate balance and update Firestore
  saveUpdateBtn.disabled = true;
  saveUpdateBtn.textContent = "Saving...";

  const batch = firestore.batch();

  currentItem.forEach(item => {
  item["BALANCE"] = item["Quantity Ordered"] - item["Quantity Delivered"] - item["Quantity Cancelled"];

  if (!item["docId"]) {
    console.error("‚ùå Missing docId for item:", item);
    return;
  }

  const docRef = firestore.collection("orders")
    .doc(currentUserId)
    .collection("userOrders")
    .doc(item["docId"]);

  console.log("‚úÖ Updating document:", item["docId"]);
  batch.update(docRef, item);
});


  batch.commit()
    .then(() => {
      alert("Order items updated successfully.");

      // Update fullData in memory
      currentItem.forEach(updated => {
        const index = fullData.findIndex(item => item["docId"] === updated["docId"]);


        if (index !== -1) {
          fullData[index] = { ...updated };
        }
      });

      populateTable(fullData);
      updateSummary(fullData);
      updateOrderModal.hide();
    })
    .catch(error => {
      console.error("Update failed:", error);
      alert("Failed to update. See console for details.");
    })
    .finally(() => {
      saveUpdateBtn.disabled = false;
      saveUpdateBtn.textContent = "Save";
    });
});



async function saveOrdersToFirestore(userId, ordersArray) {
  console.log("Saving to Firestore:", ordersArray); // ‚úÖ log this

  const batch = firestore.batch();
  const ordersCollection = firestore.collection('orders').doc(userId).collection('userOrders');

  // Optional: delete existing first (up to 500 only)
  const existingOrders = await ordersCollection.get();
  existingOrders.forEach(doc => batch.delete(doc.ref));

  ordersArray.forEach((order, index) => {
    const uniqueId = `${order.Number || 'order'}-${index}`;
    order["docId"] = uniqueId;
    const docRef = ordersCollection.doc(uniqueId);
    batch.set(docRef, order);
  });

  await batch.commit();
}







  function determineStatus(row) {
    const delivered = Number(row["Quantity Delivered"] || 0);
    const ordered = Number(row["Quantity Ordered"] || 0);
    const cancelled = Number(row["Quantity Cancelled"] || 0);

    if (cancelled > 0) return 'Cancelled';
    if (delivered === ordered && ordered > 0) return 'Delivered';
    if (delivered > 0 && delivered < ordered) return 'Partial';
    return 'Pending';
  }



  function getStatusClass(status) {
    const s = status.toLowerCase();
    return s === 'delivered' ? 'status-delivered' :
           s === 'cancelled' ? 'status-cancelled' :
           s === 'partial' ? 'status-partial' : '';
  }

  function formatDate(value) {
    if (!value) return '';
    let d;

    if (typeof value === 'string') {
      const match = value.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
      d = match ? new Date(match[3], match[1] - 1, match[2]) : new Date(value);
    } else if (!isNaN(value)) {
      d = new Date(Date.UTC(1899, 11, 30) + value * 86400000);
    }

    return d instanceof Date && !isNaN(d.getTime()) ? 
      d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : '';
  }

  function updateSummary(data) {
  let delivered = 0, cancelled = 0, inProgress = 0, partiallyDelivered = 0;

  data.forEach(row => {
    const ordered = Number(row["Quantity Ordered"] || 0);
    const deliveredQty = Number(row["Quantity Delivered"] || 0);
    const cancelledQty = Number(row["Quantity Cancelled"] || 0);

    if (deliveredQty === ordered && ordered > 0) {
      delivered++;
    } else if (cancelledQty > 0 && deliveredQty === 0) {
      cancelled++;
    } else if (deliveredQty > 0 && deliveredQty !== ordered) {
      partiallyDelivered++;
    } else if (deliveredQty === 0 && cancelledQty === 0) {
      inProgress++;
    }
  });

  document.getElementById('totalOrders').textContent = data.length;
  document.getElementById('deliveredOrders').textContent = delivered;
  document.getElementById('cancelledOrders').textContent = cancelled;
  document.getElementById('partialOrders').textContent = inProgress;

  // üëá Update Partially Delivered count if element exists
  const partialElem = document.getElementById('partiallyDeliveredOrders');
  if (partialElem) partialElem.textContent = partiallyDelivered;
}


function filterTable() {
  console.log('filterTable called');

  const searchInput = document.getElementById('searchInput');
  const statusSelect = document.getElementById('statusFilter');

  const search = (searchInput?.value || '').toLowerCase();
  const statusFilter = (statusSelect?.value || '').toLowerCase();

  console.log('Search:', search, 'Status filter:', statusFilter);

  const filtered = fullData.filter(row => {
    const customerRaw = row["Customer"] ?? row["Supplier"] ?? '';
    const productRaw = row["Product"] ?? row["Description"] ?? '';

    const customer = String(customerRaw).toLowerCase();
    const product = String(productRaw).toLowerCase();

    let status = '';
    try {
      status = determineStatus(row).toLowerCase();
    } catch (err) {
      console.warn("Invalid row during status determination:", row, err);
    }

    return (customer.includes(search) || product.includes(search)) &&
           (!statusFilter || status === statusFilter);
  });

  console.log('Filtered data count:', filtered.length);

  populateTable(filtered);
  updateSummary(filtered);
}



  function submitRemarks() {
    const newText = document.getElementById('newRemarks').value.trim();
    const orderId = currentEditingOrderId;

    if (!orderId || !currentUserId) return;

    firestore.collection('orders').doc(currentUserId).collection('userOrders').doc(orderId)
      .update({ REMARKS: newText })
      .then(() => {
        // Update local data and UI
        const row = fullData.find(r => r["Number"] == orderId);
        if (row) row["REMARKS"] = newText;
        populateTable(fullData);
        console.log('Remarks updated in Firestore');
      })
      .catch(err => console.error('Error updating remarks:', err));

    const modalEl = document.getElementById('editModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
  }


function renderCharts(data) {
  const currency = document.getElementById("currencySelector")?.value || "ALL";

// chart1Type and chart2Type are already defined globally and updated

  // üì¶ Monthly Revenue per currency
  const monthlySales = {};
  const monthlyOrders = {};

  data.forEach(order => {
    const orderDate = order["Order Date"];
    const orderCurrency = order["Currency"] || "PHP";
    const unitPrice = parseFloat(order["Unit Price"] || 0);
    const qty = parseFloat(order["Quantity Ordered"] || 0);

    if (!orderDate || isNaN(unitPrice) || isNaN(qty)) return;

    const date = new Date(orderDate);
    const monthYear = date.toLocaleString("default", { month: "short", year: "numeric" });

    // Monthly Revenue
    if (currency === "ALL" || currency === orderCurrency) {
      monthlySales[monthYear] = (monthlySales[monthYear] || 0) + qty * unitPrice;
    }

    // Monthly Order Count (always counts all regardless of currency filter)
    monthlyOrders[monthYear] = (monthlyOrders[monthYear] || 0) + 1;
  });

  const labels = [...new Set([...Object.keys(monthlySales), ...Object.keys(monthlyOrders)])].sort((a, b) => {
    return new Date(a) - new Date(b);
  });

  const salesData = labels.map(month => monthlySales[month] || 0);
  const ordersData = labels.map(month => monthlyOrders[month] || 0);

  // üí∏ Monthly Revenue Chart
  const salesCtx = document.getElementById("chartCanvas").getContext("2d");
  if (chartInstance) chartInstance.destroy();
  const isAreaChart = chart1Type === 'area';
const actualChartType = chart1Type === 'area' ? 'line' : chart1Type;

chartInstance = new Chart(salesCtx, {
  type: actualChartType,

  data: {
    labels,
    datasets: [{
      label: `Monthly Sales (${currency})`,
      data: salesData,
      borderColor: "#007aff",
      backgroundColor: isAreaChart ? "rgba(0,122,255,0.2)" : "transparent",
      fill: isAreaChart,
      tension: 0.4,
      borderWidth: 2.5,
      pointRadius: 4
    }]
  },

    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: ctx => `${currency} ${ctx.parsed.y.toFixed(2)}`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: val => `${currency} ${val.toLocaleString()}`
          }
        }
      }
    }
  });

  // üßæ Orders Issued Chart
  const ordersCtx = document.getElementById("ordersIssuedChart").getContext("2d");
  if (ordersChartInstance) ordersChartInstance.destroy();
const isOrdersArea = chart2Type === 'area';
const actualOrdersChartType = isOrdersArea ? 'line' : chart2Type;

ordersChartInstance = new Chart(ordersCtx, {
  type: actualOrdersChartType,


    data: {
      labels,
      datasets: [{
  label: "Orders Issued",
  data: ordersData,
  backgroundColor: isOrdersArea ? "rgba(52, 199, 89, 0.3)" : "#34c759",
  borderColor: "#34c759",
  fill: isOrdersArea, // This fills the area under the line only if it's an area chart
  tension: 0.4,
  borderWidth: 2.5,
  pointRadius: 4,
  borderRadius: isOrdersArea ? 0 : 8  // Only apply borderRadius if bar chart
}]

    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.parsed.y} Orders`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
}



// üéõÔ∏è Customize Chart Modal Functionality
document.getElementById('btnCustomizeCharts').addEventListener('click', () => {
  // Load stored values or set default
  const storedChart1 = localStorage.getItem('chart1Type') || 'line';
  const storedChart2 = localStorage.getItem('chart2Type') || 'bar';

  document.getElementById('chart1Type').value = storedChart1;
  document.getElementById('chart2Type').value = storedChart2;

  const modal = new bootstrap.Modal(document.getElementById('customizeChartModal'));
  modal.show();
});

document.getElementById('confirmChartChoices').addEventListener('click', () => {
chart1Type = document.getElementById('chart1Type').value;
chart2Type = document.getElementById('chart2Type').value;

localStorage.setItem('chart1Type', chart1Type);
localStorage.setItem('chart2Type', chart2Type);

renderCharts(fullData);


  const modalEl = document.getElementById('customizeChartModal');
  const modal = bootstrap.Modal.getInstance(modalEl);
  modal.hide();
});










document.getElementById("currencySelector").addEventListener("change", () => {
  renderCharts(fullData);
});



document.getElementById("btnDownloadExcel").addEventListener("click", () => {
  const tableBody = document.getElementById("orderTableBody");
  if (!tableBody) return;

  const rows = Array.from(tableBody.querySelectorAll("tr"));
  if (rows.length === 0) {
    alert("No rows available to export.");
    return;
  }

  const exportData = rows.map(row => {
    const cells = row.querySelectorAll("td");
    const rowData = {};

    selectedColumns.forEach((col, index) => {
      const cell = cells[index];
      if (!cell) {
        rowData[col] = "";
      } else {
        const select = cell.querySelector("select");
        if (select) {
          rowData[col] = select.value;
        } else {
          rowData[col] = cell.textContent.trim();
        }
      }
    });

    return rowData;
  });

  const worksheet = XLSX.utils.json_to_sheet(exportData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "FilteredOrders");

  const fileName = `Filtered_Orders_${new Date().toISOString().slice(0, 10)}.xlsx`;
  XLSX.writeFile(workbook, fileName);
});







document.addEventListener("DOMContentLoaded", () => {
  // STEP 1: When user clicks "üìÑ To Follow-Up Report"
  document.getElementById("toFollowUpBtn").addEventListener("click", (e) => {
    e.preventDefault();

    // Populate Supplier Dropdown
    const dropdown = document.getElementById("supplierDropdown");
    dropdown.innerHTML = '<option value="" disabled selected>Select a supplier</option>';

    const suppliers = [...new Set(fullData.map(item => item["Supplier"]).filter(Boolean))];
    suppliers.forEach(supplier => {
      const option = document.createElement("option");
      option.value = supplier;
      option.textContent = supplier;
      dropdown.appendChild(option);
    });

    // Show Supplier Selection Modal
    const supplierModal = new bootstrap.Modal(document.getElementById("reportModal"));
    supplierModal.show();
  });

  // STEP 2: When user clicks "Generate Report" button in the Supplier Modal
  document.getElementById("generateFollowUpReport").addEventListener("click", () => {
    const selectedSupplier = document.getElementById("supplierDropdown").value;
    if (!selectedSupplier) return;

    const reportTableBody = document.getElementById("reportTableBody");
    const supplierNameDisplay = document.getElementById("selectedSupplierName");

    const inProgressOrders = fullData.filter(order => {
      const delivered = Number(order["Quantity Delivered"] || 0);
      const ordered = Number(order["Quantity Ordered"] || 0);
      const cancelled = Number(order["Quantity Cancelled"] || 0);
      const isInProgress = cancelled === 0 && delivered < ordered;
      return order["Supplier"] === selectedSupplier && isInProgress;
    });

    supplierNameDisplay.textContent = selectedSupplier;
    reportTableBody.innerHTML = '';

 inProgressOrders.forEach(order => {
  const balance = (order["Quantity Ordered"] || 0) - (order["Quantity Delivered"] || 0);
const remarks = order["Remarks"] || '';
const row = document.createElement("tr");
row.innerHTML = `
  <td>${order["Number"] || ''}</td>
  <td>${order["Product"] || order["Description"] || ''}</td>
  <td>${order["Unit Price"] || 0}</td>
  <td>${order["Quantity Ordered"] || 0}</td>
  <td>${order["Amount"] || 0}</td>
  <td>${order["Quantity Delivered"] || 0}</td>
  <td>${order["Quantity Cancelled"] || 0}</td>
  <td>${balance}</td>
  <td>${order["Need By Date"] || ''}</td>
  <td class="remarks-cell" data-full-text="${remarks.replace(/"/g, '&quot;')}">${remarks}</td>
`;
  reportTableBody.appendChild(row);
});





















function makeTableResizable(tableSelector) {
  const table = document.querySelector(tableSelector);
  const thElements = table.querySelectorAll('th');

  thElements.forEach((th, index) => {
    // üîÅ Remove old resizer if it exists
    const oldResizer = th.querySelector('.column-resizer');
    if (oldResizer) oldResizer.remove();

    const resizer = document.createElement('div');
    resizer.classList.add('column-resizer');
    resizer.style.width = '5px';
    resizer.style.height = '100%';
    resizer.style.position = 'absolute';
    resizer.style.right = '0';
    resizer.style.top = '0';
    resizer.style.cursor = 'col-resize';
    resizer.style.userSelect = 'none';
    resizer.style.zIndex = '1';

    th.style.position = 'relative';
    th.appendChild(resizer);

    resizer.addEventListener('mousedown', (e) => {
      e.preventDefault();
      const startX = e.pageX;
      const startWidth = th.offsetWidth;

      const onMouseMove = (e) => {
        const newWidth = startWidth + (e.pageX - startX);
        th.style.width = `${newWidth}px`;
        table.querySelectorAll('tr').forEach(row => {
          const cell = row.children[index];
          if (cell) cell.style.width = `${newWidth}px`;
        });
      };

      const onMouseUp = () => {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      };

      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    });
  });
}

// Call this after the Follow-Up Report table is generated
makeTableResizable('.apple-style-report-table');




function downloadTableAsCSV(tableId, filename = 'follow_up_report.csv') {
    const table = document.getElementById(tableId);
    const rows = Array.from(table.querySelectorAll('tr'));
    const csv = rows.map(row =>
      Array.from(row.querySelectorAll('th, td'))
        .map(cell => `"${cell.innerText.replace(/"/g, '""')}"`)
        .join(',')
    ).join('\n');

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }

  document.getElementById("downloadFollowUpReport").addEventListener("click", () => {
    downloadTableAsCSV("followUpReportTable");
  });








    // Show Follow-Up Report Output Modal
    const reportOutputModal = new bootstrap.Modal(document.getElementById("reportOutputModal"));
    reportOutputModal.show();

    // Close Supplier Modal
    const reportModal = bootstrap.Modal.getInstance(document.getElementById("reportModal"));
    reportModal.hide();
  });
});



function computeTentativeDate(orderDate, leadTime) {
  if (!orderDate || !leadTime || leadTime === "Selection") return '';

  const order = new Date(orderDate);
  let maxWorkingDays = 0;

  if (leadTime.includes('Weeks')) {
    const parts = leadTime.split('-');
    const maxWeeks = parseInt(parts[1]) || parseInt(parts[0]) || 0;
    maxWorkingDays = maxWeeks * 5;
  } else if (leadTime.includes('Days')) {
    const parts = leadTime.split('-');
    const maxDays = parseInt(parts[1]) || parseInt(parts[0]) || 0;
    maxWorkingDays = maxDays;
  }

  let daysAdded = 0;
  let tentative = new Date(order);

  while (daysAdded < maxWorkingDays) {
    tentative.setDate(tentative.getDate() + 1);
    const day = tentative.getDay();
    if (day !== 0 && day !== 6) daysAdded++;
  }

  return tentative.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}



































function generateDeliveryPerformanceReport(startDate, endDate) {
  const grouped = {};

  fullData.forEach(order => {
    // ‚úÖ Format the dates first
    order["Order Date"] = formatDateDisplay(order["Order Date"]);
    order["Tentative Delivery Date"] = formatDateDisplay(order["Tentative Delivery Date"]);
    order["Delivery Date"] = formatDateDisplay(order["Delivery Date"]);

    const approved = new Date(order["Order Date"]);
    if (approved < startDate || approved >= endDate) return;

    const supplier = order["Supplier"] || "Unknown Supplier";
    if (!grouped[supplier]) grouped[supplier] = [];

    const tentative = new Date(order["Tentative Delivery Date"]);
    const delivery = order["Delivery Date"] ? new Date(order["Delivery Date"]) : null;

    let status = "";
    if (delivery && delivery <= tentative) {
      status = "On Time";
    } else if (delivery && delivery > tentative) {
      status = "Delayed";
    } else if (!delivery && tentative < new Date()) {
      status = "Delayed";
    } else {
      status = "Pending";
    }

    grouped[supplier].push({
      orderNumber: order["Number"] || "N/A",
      description: order["Description"] || "",
      orderDate: order["Order Date"] || "",
      tentativeDate: order["Tentative Delivery Date"] || "",
      deliveryDate: order["Delivery Date"] || "",
      status: status
    });
  });

  renderDeliveryPerformanceToModal(grouped);
  new bootstrap.Modal(document.getElementById("deliveryPerformanceModal")).show();
}







document.getElementById('confirmDateRangeBtn').addEventListener('click', () => {
  const startMonth = document.getElementById('startMonth').value;
  const endMonth = document.getElementById('endMonth').value;

  if (!startMonth || !endMonth) {
    alert("Please select both start and end month.");
    return;
  }

  const startDate = new Date(startMonth + "-01");
  const endDate = new Date(endMonth + "-01");
  endDate.setMonth(endDate.getMonth() + 1); // include full end month

  generateDeliveryPerformanceReport(startDate, endDate);
  bootstrap.Modal.getInstance(document.getElementById("dateRangeModal")).hide();
});


document.getElementById('deliveryperformanceBtn').addEventListener('click', () => {
  new bootstrap.Modal(document.getElementById("dateRangeModal")).show();
});



function generateDeliveryPerformanceReport(startDate, endDate) {
  const grouped = {};

  fullData.forEach(order => {
    const orderDate = new Date(order["Order Date"]);
    if (orderDate < startDate || orderDate >= endDate) return;



    const supplier = order["Supplier"] || "Unknown Supplier";
    if (!grouped[supplier]) grouped[supplier] = [];

    const tentative = new Date(order["Tentative Delivery Date"]);
    const delivery = order["Delivery Date"] ? new Date(order["Delivery Date"]) : null;

    let status = "";

    if (delivery && delivery <= tentative) {
      status = "On Time";
    } else if (delivery && delivery > tentative) {
      status = "Delayed";
    } else if (!delivery && tentative < new Date()) {
      status = "Delayed";
    } else {
      status = "Pending";
    }

    grouped[supplier].push({
      orderNumber: order["Number"] || "N/A",
      description: order["Description"] || "",
      orderDate: order["Order Date"] || "",
      tentativeDate: order["Tentative Delivery Date"] || "",
      deliveryDate: order["Delivery Date"] || "",
      status: status
    });
  });

  renderDeliveryPerformanceToModal(grouped);
  new bootstrap.Modal(document.getElementById("deliveryPerformanceModal")).show();
}


function renderDeliveryPerformanceToModal(grouped) {
  const container = document.getElementById("deliveryPerformanceContent");
  container.innerHTML = ''; // Clear previous content

  if (Object.keys(grouped).length === 0) {
    container.innerHTML = `<p class="text-muted">No matching data found for the selected range.</p>`;
    return;
  }

  Object.entries(grouped).forEach(([supplier, records]) => {
    // Count statuses
    let onTime = 0, delayed = 0, pending = 0;

    records.forEach(record => {
      if (record.status === "On Time") onTime++;
      else if (record.status === "Delayed") delayed++;
      else if (record.status === "Pending") pending++;
    });

    // Supplier header with summary
    const summaryBox = document.createElement("div");
    summaryBox.className = "mb-2 p-3 rounded bg-light border";

    summaryBox.innerHTML = `
      <h6 class="mb-2 text-primary">üì¶ ${supplier}</h6>
      <div class="d-flex gap-3 flex-wrap small">
        <span><strong>On Time:</strong> <span class="text-success">${onTime}</span></span>
        <span><strong>Delayed:</strong> <span class="text-danger">${delayed}</span></span>
        <span><strong>Pending:</strong> <span class="text-warning">${pending}</span></span>
        <span><strong>Total:</strong> ${records.length}</span>
      </div>
    `;

    // Table for detailed records
    const table = document.createElement("table");
    table.className = "table table-bordered table-sm mb-4";

  table.innerHTML = `
  <thead class="table-light">
  <tr>
    <th>Order #</th>
    <th>Description</th>
    <th>Order Date</th>
    <th>Tentative Delivery Date</th>
    <th>Delivery Date</th>
    <th>Status</th>
  </tr>
</thead>

  <tbody>
    ${records.map(record => `
      <tr>
        <td>${record.orderNumber}</td>
        <td>${record.description}</td>
        <td>${record.orderDate || '-'}</td>
        <td>${record.tentativeDate || '-'}</td>
        <td>${formatDateDisplay(record.deliveryDate) || '-'}</td>
        <td><span class="badge ${getStatusBadgeClass(record.status)}">${record.status}</span></td>
      </tr>
    `).join('')}
  </tbody>
`;



    // Append summary and table to the modal
    container.appendChild(summaryBox);
    container.appendChild(table);
  });
}

function getStatusBadgeClass(status) {
  switch (status) {
    case "On Time": return "bg-success";
    case "Delayed": return "bg-danger";
    case "Pending": return "bg-warning text-dark";
    default: return "bg-secondary";
  }
}


function isValidDate(str) {
  const d = new Date(str);
  return !isNaN(d.getTime());
}











function formatDateDisplay(dateValue) {
  if (!dateValue) return "";

  // ‚úÖ Excel serial number (e.g., 45646)
  if (!isNaN(dateValue) && Number(dateValue) > 59 && Number(dateValue) < 60000) {
    const excelEpoch = new Date(1899, 11, 30);
    const date = new Date(excelEpoch.getTime() + Number(dateValue) * 86400000);
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    }); // ‚ûú February 28, 2025
  }

  // ‚úÖ Date object
  if (Object.prototype.toString.call(dateValue) === "[object Date]" && !isNaN(dateValue)) {
    return dateValue.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }

  // ‚úÖ yyyy-mm-dd format
  if (/^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
    const [yyyy, mm, dd] = dateValue.split("-");
    const date = new Date(`${yyyy}-${mm}-${dd}`);
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }

  // ‚úÖ mm/dd/yyyy format
  if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateValue)) {
    const [mm, dd, yyyy] = dateValue.split("/");
    const date = new Date(`${yyyy}-${mm}-${dd}`);
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }

  return dateValue; // fallback
}

















 document.getElementById("logoutBtn").addEventListener("click", async () => {
  const user = firebase.auth().currentUser;

  if (user) {
    try {
      await firebase.firestore()
        .collection("users")
        .doc(user.uid)
        .update({
          sessionActive: false,
          lastSession: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (err) {
      console.error("Failed to update sessionActive on logout:", err);
    }
  }

  await firebase.auth().signOut();
  window.location.href = "loginindex.html";
});

function resetTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
  logoutUser();
}, 5 * 60 * 1000); // 5 minutes


  }

  function logoutUser() {
    alert("You've been logged out due to inactivity.");
    // Clear session or Firebase auth, if used
    localStorage.clear();
    sessionStorage.clear();

    // Example for Firebase logout
    if (typeof firebase !== 'undefined' && firebase.auth) {
      firebase.auth().signOut().then(() => {
        window.location.href = "Loginindex.html"; // Redirect to login page
      });
    } else {
      window.location.href = "index.html";
    }
  }

  // Listen to user activity
  window.addEventListener('mousemove', resetTimer);
  window.addEventListener('keydown', resetTimer);
  window.addEventListener('scroll', resetTimer);
  window.addEventListener('click', resetTimer);

  // Start timer initially
  resetTimer();





</script>





</body>
</html>
