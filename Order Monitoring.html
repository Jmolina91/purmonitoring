<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Monitoring Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
 <style>
:root {
  --apple-blue: #007aff;
  --sidebar-bg: #f9fafc;
  --sidebar-border: #dce1e6;
  --text-main: #1c1c1e;
  --text-muted: #8e8e93;
  --highlight: #0a84ff;
  --card-bg: #ffffff;
  --card-shadow: rgba(0, 0, 0, 0.06);
  --hover-shadow: rgba(0, 0, 0, 0.1);
  --transition-fast: 0.25s ease;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background-color: #f2f4f8;
  color: var(--text-main);
  margin: 0;
  padding: 0;
  overflow-x: hidden;
}

/* === Sidebar === */
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  width: 260px;
  height: 100vh;
  background-color: var(--sidebar-bg);
  border-right: 1px solid var(--sidebar-border);
  padding: 2rem 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  box-shadow: 4px 0 12px rgba(0, 0, 0, 0.04);
  transition: all var(--transition-fast);
  z-index: 1000;
}

.sidebar h2 {
  font-size: 1.5rem;
  color: var(--highlight);
  margin: 0 0 1rem;
}

.sidebar-btn {
  background: var(--highlight);
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 24px;
  color: #fff;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: background var(--transition-fast), transform var(--transition-fast);
}

.sidebar-btn:hover {
  background: #005bb5;
  transform: scale(1.03);
}

/* === Main Content === */
.main-content {
  margin-left: 260px;
  padding: 2rem;
  transition: margin-left var(--transition-fast);
}

/* === Card Summary === */
.card-summary {
  background: var(--card-bg);
  padding: 1.5rem 2rem;
  border-radius: 16px;
  box-shadow: 0 4px 14px var(--card-shadow);
  border-left: 5px solid var(--highlight);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card-summary:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 24px var(--hover-shadow);
}

/* === Upload Zone === */
.upload-zone {
  border: 2px dashed #c7c7cc;
  background-color: #f4f4f7;
  padding: 2rem;
  border-radius: 12px;
  text-align: center;
  color: var(--text-muted);
  transition: all var(--transition-fast);
  cursor: pointer;
}

.upload-zone:hover {
  border-color: var(--highlight);
  color: var(--highlight);
  background-color: #e6f0ff;
}

/* === Table === */
.table-wrapper {
  overflow-x: auto;
  background: white;
  border-radius: 12px;
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.04);
  margin-top: 2rem;
}

table {
  width: 100%;
  border-collapse: collapse;
  border-spacing: 0;
  min-width: 600px;
}

th,
td {
  padding: 1rem;
  text-align: left;
  border-bottom: 1px solid #e5e5ea;
}

th {
  background-color: #f1f2f6;
  font-weight: 600;
  position: relative;
  white-space: nowrap;
  cursor: move;
  user-select: none;
  transition: background-color 0.2s ease;
}

th.dragging {
  background-color: #e0f0ff;
  opacity: 0.6;
}

th .resizer {
  position: absolute;
  right: 0;
  top: 0;
  width: 6px;
  height: 100%;
  cursor: col-resize;
  background-color: transparent;
}

th .resizer:hover {
  background-color: #ccc;
}

/* === Chart Styling === */
.chart-wrapper {
  height: 240px;
}

#chartCanvas,
#ordersIssuedChart {
  width: 100% !important;
  height: 240px !important;
}

/* === Side-by-side Charts === */
.chart-duo {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}

.chart-box {
  flex: 1;
  min-width: 300px;
}

/* Divider */
.chart-divider {
  width: 1px;
  background-color: #e0e0e0;
  margin: 0 10px;
}

@media (max-width: 992px) {
  .chart-duo {
    flex-direction: column;
  }
  .chart-divider {
    display: none;
  }
}

/* === Status Tags === */
.status-delivered {
  color: #34c759;
  font-weight: 600;
}

.status-cancelled {
  color: #ff3b30;
  font-weight: 600;
}

.status-partial {
  color: #ff9500;
  font-weight: 600;
}

/* === Fade Animation === */
.fade-in {
  animation: fadeIn 0.5s ease-in-out both;
}

@keyframes fadeIn {
  0% {
    opacity: 0;
    transform: translateY(10px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}


  </style>
</head>
<body>
  <!-- NAVIGATION -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">üì¶ Order Monitor</a>
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link active" href="#">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="Chart project.html">Charts</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Upload</a></li>
      </ul>
      <span id="userEmailDisplay" class="navbar-text text-white ms-auto"></span>
    </div>
  </nav>

  <!-- SIDEBAR -->
  <div id="sidebar" class="sidebar">
    <h5 class="sidebar-title">Functions</h5>
    <button id="btnShowUpdate" class="btn btn-primary sidebar-btn w-100 mb-3">UPDATE ORDER DETAILS</button>
    <button id="btnCustomizeTable" class="btn btn-primary sidebar-btn w-100 mb-3">Customize Table</button>
  </div>

  <!-- MAIN CONTENT -->
  <div id="mainContent" style="margin-left: 270px; padding: 20px;">

    <!-- DASHBOARD SUMMARY -->
    <div class="container-fluid p-0 mb-4">
      <div class="row text-center gx-3">
        <div class="col-md-3 mb-3">
          <div class="card card-summary">
            <div class="card-body">
              <h5>Total Orders</h5>
              <h3 id="totalOrders">--</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card card-summary">
            <div class="card-body">
              <h5>Delivered</h5>
              <h3 class="text-success" id="deliveredOrders">--</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card card-summary">
            <div class="card-body">
              <h5>Cancelled</h5>
              <h3 class="text-danger" id="cancelledOrders">--</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card card-summary">
            <div class="card-body">
              <h5>In Progress</h5>
              <h3 class="text-warning" id="partialOrders">--</h3>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- FILTERS + UPLOAD -->
    <div class="container-fluid p-0 mb-4">
      <div class="row gx-3">
        <div class="col-md-3">
          <input type="text" class="form-control" placeholder="Search Customer/Product..." id="searchInput">
        </div>
        <div class="col-md-3">
          <select class="form-select" id="statusFilter">
            <option value="">All Status</option>
            <option value="Delivered">Delivered</option>
            <option value="Cancelled">Cancelled</option>
            <option value="Partial">Partial</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="upload-zone" for="excelFile">
            üìÅ Click or drag Excel file to upload
            <input type="file" id="excelFile" accept=".xlsx, .xls" hidden>
          </label>
        </div>
      </div>
    </div>




<!-- üìä Side-by-Side Charts -->
<div class="container-fluid p-0 mb-4">
  <div class="d-flex flex-wrap justify-content-between chart-duo">

    <!-- Left Chart: Monthly Sales -->
    <div class="chart-box me-md-3 mb-3 mb-md-0">
      <div class="card shadow-sm rounded-4 border-0 h-100">
        <div class="card-body px-4 pt-4 pb-2">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0" style="font-weight: 600; color: #1d1d1f;">üìä Monthly Sales Overview</h5>
            <select id="currencySelector" class="form-select form-select-sm" style="max-width: 150px; border-radius: 12px;">
              <option value="ALL">All Currencies</option>
              <option value="PHP">PHP</option>
              <option value="USD">USD</option>
              <option value="JPY">JPY</option>
            </select>
          </div>
          <div class="chart-wrapper">
            <canvas id="chartCanvas"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Divider Line -->
    <div class="chart-divider d-none d-md-block"></div>

   <!-- Right Chart: Orders Issued -->
<div class="chart-box ms-md-3">
  <div class="card shadow-sm rounded-4 border-0 h-100">
    <div class="card-body px-4 pt-4 pb-2">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0" style="font-weight: 600; color: #1d1d1f;">üßæ Total Orders Issued Per Month</h5>
        <select id="orderSortSelector" class="form-select form-select-sm" style="max-width: 150px; border-radius: 12px;">
          <option value="month">Sort by Month</option>
          <option value="asc">Sort by Value (Asc)</option>
          <option value="desc">Sort by Value (Desc)</option>
        </select>
      </div>
      <div class="chart-wrapper">
        <canvas id="ordersIssuedChart"></canvas>
      </div>
    </div>
  </div>
</div>

  </div>
</div>









    <!-- ORDERS TABLE -->
    <div class="container-fluid p-0 mb-5">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">üìã Order List</h5>
        </div>
        <div class="card-body p-0">
          <div style="max-height: 500px; overflow-y: auto;">
            <table class="table table-hover table-bordered align-middle mb-0">
              <thead id="orderTableHead" class="table-light sticky-top">
                <!-- Dynamic headers inserted here -->
              </thead>
              <tbody id="orderTableBody">
                <!-- JavaScript will populate rows here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>





  <!-- UPDATE ORDER MODAL -->
  <div class="modal fade" id="updateOrderModal" tabindex="-1" aria-labelledby="updateOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-lg border-0">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title" id="updateOrderModalLabel">
            Update Order <span id="modalOrderNumber" class="text-primary"></span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body pt-0">
          <div id="multiItemContainer">
            <table class="table table-bordered table-hover">
              <thead class="table-light">
                <tr>
                  <th>Product</th>
                  <th>Qty Ordered</th>
                  <th>Qty Delivered</th>
                  <th>Qty Cancelled</th>
                  <th>Unit Price</th>
                  <th>Remarks</th>
                </tr>
              </thead>
              <tbody id="multiItemTableBody">
                <!-- JavaScript will inject rows -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveUpdateBtn" class="btn btn-primary rounded-pill px-4">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CUSTOMIZE TABLE MODAL -->
  <div class="modal fade" id="customizeTableModal" tabindex="-1" aria-labelledby="customizeTableModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="customizeTableModalLabel">Select Columns to Display</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="columnCheckboxContainer">
          <!-- Checkbox list rendered by JS -->
        </div>
        <div class="modal-footer">
          <button type="button" id="confirmColumnsBtn" class="btn btn-success">Apply</button>
          <button type="button" class="btn btn-secondary" onclick="resetColumns()">Reset</button>
        </div>
      </div>
    </div>
  </div>


</body>


 
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD9LCzMuEGIiRQrOVCgH6d-jxxJLZ0QBCk",
    authDomain: "order-monitoring-purchasing.firebaseapp.com",
    projectId: "order-monitoring-purchasing",
    storageBucket: "order-monitoring-purchasing.appspot.com",
    messagingSenderId: "209378598320",
    appId: "1:209378598320:web:0c143d69bc329a994d8a75",
    measurementId: "G-PPNWT4ECV0"
  };

  firebase.initializeApp(firebaseConfig);
  firebase.analytics();

  const auth = firebase.auth();
  const firestore = firebase.firestore();
const btnCustomizeTable = document.getElementById('btnCustomizeTable');
const customizeTableModal = new bootstrap.Modal(document.getElementById('customizeTableModal'));
const columnCheckboxContainer = document.getElementById('columnCheckboxContainer');
const confirmColumnsBtn = document.getElementById('confirmColumnsBtn');












  let fullData = [];
const monthOrderIndex = {
  Jan: 0, Feb: 1, Mar: 2, Apr: 3, May: 4, Jun: 5,
  Jul: 6, Aug: 7, Sep: 8, Oct: 9, Nov: 10, Dec: 11
};




  let currentEditingOrderId = '';
  let currentUserId = null; // Use UID for Firestore path
  let chartInstance = null;
  let selectedColumns = [];  // Store which columns are selected
  let draggedColumnIndex = null;
  let ordersChartInstance = null; 
  let globalOrderStats = [];
  let chartInstance, ordersChartInstance; // Declare global if not already

const storedCols = localStorage.getItem('selectedColumns');
if (storedCols) {
  try {
    selectedColumns = JSON.parse(storedCols);
  } catch (e) {
    selectedColumns = [];
  }
}

btnCustomizeTable.addEventListener('click', () => {
  if (!fullData.length) {
    alert('No data loaded yet.');
    return;
  }

  const headers = Object.keys(fullData[0]);
  columnCheckboxContainer.innerHTML = headers.map(header => {
    const checked = selectedColumns.length === 0 || selectedColumns.includes(header);
    return `
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="${header}" id="col-${header}" ${checked ? 'checked' : ''}>
        <label class="form-check-label" for="col-${header}">${header}</label>
      </div>
    `;
  }).join('');

  customizeTableModal.show();
});

function resetColumns() {
  selectedColumns = [];
  localStorage.removeItem('selectedColumns');
  customizeTableModal.hide();
  populateTable(fullData);
}


















  auth.onAuthStateChanged(user => {
    if (user) {
      currentUserId = user.uid;

      // Display user email in navbar (make sure you have element with this ID)
      const emailElem = document.getElementById('userEmailDisplay');
      if(emailElem) emailElem.textContent = user.email || 'User';

      // Load orders from Firestore collection
      loadOrdersFromFirestore(currentUserId);
    } else {
      // If no user, redirect to login
      window.location.href = "login.html";
    }
  });

  document.getElementById('excelFile').addEventListener('change', handleFile, false);
  document.getElementById('searchInput').addEventListener('input', filterTable);
  document.getElementById('statusFilter').addEventListener('change', filterTable);

 async function loadOrdersFromFirestore(userId) {
  try {
    console.log("Loading orders for user:", userId); // ‚úÖ Add this line

    const ordersSnapshot = await firestore
      .collection('orders')
      .doc(userId)
      .collection('userOrders')
      .get();

    fullData = [];
    ordersSnapshot.forEach(doc => {
      const data = doc.data();
      data["docId"] = doc.id;
      fullData.push(data);
    });

    console.log("Loaded fullData:", fullData); // ‚úÖ Log the loaded data

    populateTable(fullData);
    updateSummary(fullData);
    renderCharts(fullData);
  } catch (error) {
    console.error("Error loading user orders:", error);
    fullData = [];
    populateTable(fullData);
    updateSummary(fullData);
  }
}


  function handleFile(e) {
  const file = e.target.files[0];
  if (!file || !currentUserId) return;

  const reader = new FileReader();
  reader.onload = async function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
    
    fullData = XLSX.utils.sheet_to_json(worksheet);
    console.log("Excel parsed data:", fullData); // ‚úÖ Log parsed result

    if (!fullData.length) {
      alert("Excel is empty or has no valid header row.");
      return;
    }

    const dateFields = ["Order Date", "Need By Date", "Approved Date"];
    fullData = fullData.map(row => {
      dateFields.forEach(field => {
        if (row[field]) row[field] = formatDate(row[field]);
      });
      return row;
    });

    try {
      await saveOrdersToFirestore(currentUserId, fullData);
      console.log("Data saved to Firestore.");
      await loadOrdersFromFirestore(currentUserId); // ‚úÖ Force reload
    } catch (error) {
      console.error("Error saving to Firestore:", error);
    }
  };

  reader.readAsArrayBuffer(file);
}





















const btnShowUpdate = document.getElementById('btnShowUpdate');
const updateOrderModal = new bootstrap.Modal(document.getElementById('updateOrderModal'));
const modalOrderNumber = document.getElementById('modalOrderNumber');
const saveUpdateBtn = document.getElementById('saveUpdateBtn');


// Show modal and generate checkboxes
btnCustomizeTable.addEventListener('click', () => {
  if (!fullData.length) {
    alert('No data loaded yet.');
    return;
  }
  
  // Get unique headers from data keys
  const headers = Object.keys(fullData[0]);

  // Generate checkboxes, check those already selected or all by default
  columnCheckboxContainer.innerHTML = headers.map(header => {
    const checked = selectedColumns.length === 0 || selectedColumns.includes(header);
    return `
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="${header}" id="col-${header}" ${checked ? 'checked' : ''}>
        <label class="form-check-label" for="col-${header}">${header}</label>
      </div>
    `;
  }).join('');

  customizeTableModal.show();
});

// On confirm, update selected columns and re-render table
confirmColumnsBtn.addEventListener('click', () => {
  const checkboxes = columnCheckboxContainer.querySelectorAll('input[type=checkbox]');
  selectedColumns = Array.from(checkboxes)
                         .filter(cb => cb.checked)
                         .map(cb => cb.value);

  if (selectedColumns.length === 0) {
    alert('Select at least one column to display.');
    return;
  }

  customizeTableModal.hide();          // ‚úÖ Close modal
  populateTable(fullData);             // ‚úÖ Re-render table with new columns
});


// Modify populateTable to respect selectedColumns

function populateTable(data) {
  console.log("üöÄ Populating table with data:", data);

  const tbody = document.getElementById('orderTableBody');
  const thead = document.getElementById('orderTableHead');

  if (!tbody || !thead) {
    console.error("‚ùå Table elements not found. Ensure you have <thead id='orderTableHead'> and <tbody id='orderTableBody'> in your HTML.");
    return;
  }

  tbody.innerHTML = '';
  thead.innerHTML = '';

  if (!Array.isArray(data) || data.length === 0) {
    console.warn("‚ö†Ô∏è No data to populate in table.");
    return;
  }

  // Load or initialize selectedColumns
  if (!Array.isArray(selectedColumns) || selectedColumns.length === 0) {
    selectedColumns = Object.keys(data[0]).filter(key => key);
  }

  const columns = selectedColumns;

  // ‚úÖ Build header
  const headerRow = document.createElement('tr');
  columns.forEach((col) => {
    const th = document.createElement('th');
    th.textContent = col;
    th.setAttribute('draggable', true);
    th.dataset.columnName = col;

    const resizer = document.createElement('div');
    resizer.classList.add('resizer');
    th.appendChild(resizer);

    if (typeof enableResize === 'function') enableResize(th, resizer);

    th.addEventListener('dragstart', handleDragStart);
    th.addEventListener('dragover', handleDragOver);
    th.addEventListener('drop', handleDrop);

    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);

  // ‚úÖ Build rows
  data.forEach(row => {
    const tr = document.createElement('tr');
    columns.forEach(col => {
      const td = document.createElement('td');
      let value = row[col] ?? '';

      if (typeof value === 'object') {
        value = JSON.stringify(value);
      }

      if (col.toLowerCase().includes('price') || col.toLowerCase().includes('amount')) {
        value = Number(value || 0).toFixed(2);
      }

      td.textContent = value;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  console.log("‚úÖ Table populated with", data.length, "rows.");
}









function handleDragStart(e) {
  draggedColumnName = e.target.dataset.columnName;
  e.dataTransfer.effectAllowed = "move";
}

function handleDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = "move";
}

function handleDrop(e) {
  e.preventDefault();
  const dropColumnName = e.target.closest('th')?.dataset.columnName;
  if (!draggedColumnName || !dropColumnName || draggedColumnName === dropColumnName) return;

  const fromIndex = selectedColumns.indexOf(draggedColumnName);
  const toIndex = selectedColumns.indexOf(dropColumnName);

  if (fromIndex === -1 || toIndex === -1) return;

  const [moved] = selectedColumns.splice(fromIndex, 1);
  selectedColumns.splice(toIndex, 0, moved);

  localStorage.setItem('selectedColumns', JSON.stringify(selectedColumns));
  populateTable(fullData);
}

function enableResize(th, resizer) {
  let startX, startWidth;

  resizer.addEventListener('mousedown', function (e) {
    startX = e.pageX;
    startWidth = th.offsetWidth;
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
    e.preventDefault();
  });

  function onMouseMove(e) {
    const newWidth = startWidth + (e.pageX - startX);
    th.style.width = newWidth + 'px';
  }

  function onMouseUp() {
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
  }
}










// Form fields inside modal
const updateProduct = document.getElementById('updateProduct');
const updateQtyOrdered = document.getElementById('updateQtyOrdered');
const updateQtyDelivered = document.getElementById('updateQtyDelivered');
const updateQtyCancelled = document.getElementById('updateQtyCancelled');
const updateUnitPrice = document.getElementById('updateUnitPrice');
const updateRemarks = document.getElementById('updateRemarks');

let currentOrderId = null;
let currentItem = null;

btnShowUpdate.addEventListener('click', () => {
  // Ask for Order ID with prompt
  const orderId = prompt("Enter Order ID to update:");
  if (!orderId) {
    alert("No Order ID entered.");
    return;
  }

  // Search order by ID
  const matchingItems = fullData.filter(item => item["Number"] && item["Number"].toString() === orderId);

  if (matchingItems.length === 0) {
    alert("No order found with this ID.");
    return;
  }

  currentOrderId = orderId;
  currentItem = [...matchingItems]; // store full array
modalOrderNumber.textContent = orderId;

// Clear any previous rows in modal
const tableBody = document.getElementById("multiItemTableBody");
tableBody.innerHTML = "";

// Inject a row per item
matchingItems.forEach((item, index) => {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td><input type="text" class="form-control" value="${item["Description"] || ''}" data-field="Description" data-index="${index}" /></td>
    <td><input type="number" class="form-control" value="${item["Quantity Ordered"] || 0}" data-field="Quantity Ordered" data-index="${index}" /></td>
    <td><input type="number" class="form-control" value="${item["Quantity Delivered"] || 0}" data-field="Quantity Delivered" data-index="${index}" /></td>
    <td><input type="number" class="form-control" value="${item["Quantity Cancelled"] || 0}" data-field="Quantity Cancelled" data-index="${index}" /></td>
    <td><input type="number" class="form-control" value="${item["Unit Price"] || 0}" step="0.01" data-field="Unit Price" data-index="${index}" /></td>
    <td><input type="text" class="form-control" value="${item["REMARKS"] || ''}" data-field="REMARKS" data-index="${index}" /></td>
  `;
  tableBody.appendChild(row);
});


  updateOrderModal.show();
});

// You can now remove the old btnSearchOrder listener since the search happens on btnShowUpdate

saveUpdateBtn.addEventListener('click', () => {
  if (!currentUserId) {
    alert('User not authenticated');
    return;
  }

  if (!currentOrderId || !currentItem || !Array.isArray(currentItem)) {
    alert('No order loaded');
    return;
  }

  // Loop through each row to gather updated values
  const inputs = document.querySelectorAll('#multiItemTableBody input');
  inputs.forEach(input => {
    const index = parseInt(input.dataset.index);
    const field = input.dataset.field;
    let value = input.value;

    if (["Quantity Ordered", "Quantity Delivered", "Quantity Cancelled", "Unit Price"].includes(field)) {
      value = Number(value) || 0;
    }

    currentItem[index][field] = value;
  });

  // Recalculate balance and update Firestore
  saveUpdateBtn.disabled = true;
  saveUpdateBtn.textContent = "Saving...";

  const batch = firestore.batch();

  currentItem.forEach(item => {
    item["BALANCE"] = item["Quantity Ordered"] - item["Quantity Delivered"] - item["Quantity Cancelled"];
    const docRef = firestore.collection("orders")
      .doc(currentUserId)
      .collection("userOrders")
      .doc(item["docId"]);

    console.log("Updating document:", item["docId"]); // <-- Log docId before update

    batch.update(docRef, item);
  });

  batch.commit()
    .then(() => {
      alert("Order items updated successfully.");

      // Update fullData in memory
      currentItem.forEach(updated => {
        const index = fullData.findIndex(item => item["ID"] === updated["ID"] || item["docId"] === updated["docId"]);
        if (index !== -1) {
          fullData[index] = { ...updated };
        }
      });

      populateTable(fullData);
      updateSummary(fullData);
      updateOrderModal.hide();
    })
    .catch(error => {
      console.error("Update failed:", error);
      alert("Failed to update. See console for details.");
    })
    .finally(() => {
      saveUpdateBtn.disabled = false;
      saveUpdateBtn.textContent = "Save";
    });
});




















async function saveOrdersToFirestore(userId, ordersArray) {
  console.log("Saving to Firestore:", ordersArray); // ‚úÖ log this

  const batch = firestore.batch();
  const ordersCollection = firestore.collection('orders').doc(userId).collection('userOrders');

  // Optional: delete existing first (up to 500 only)
  const existingOrders = await ordersCollection.get();
  existingOrders.forEach(doc => batch.delete(doc.ref));

  ordersArray.forEach((order, index) => {
    const uniqueId = `${order.Number || 'order'}-${index}`;
    order["docId"] = uniqueId;
    const docRef = ordersCollection.doc(uniqueId);
    batch.set(docRef, order);
  });

  await batch.commit();
}







  function determineStatus(row) {
    const delivered = Number(row["Quantity Delivered"] || 0);
    const ordered = Number(row["Quantity Ordered"] || 0);
    const cancelled = Number(row["Quantity Cancelled"] || 0);

    if (cancelled > 0) return 'Cancelled';
    if (delivered === ordered && ordered > 0) return 'Delivered';
    if (delivered > 0 && delivered < ordered) return 'Partial';
    return 'Pending';
  }



  function getStatusClass(status) {
    const s = status.toLowerCase();
    return s === 'delivered' ? 'status-delivered' :
           s === 'cancelled' ? 'status-cancelled' :
           s === 'partial' ? 'status-partial' : '';
  }

  function formatDate(value) {
    if (!value) return '';
    let d;

    if (typeof value === 'string') {
      const match = value.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
      d = match ? new Date(match[3], match[1] - 1, match[2]) : new Date(value);
    } else if (!isNaN(value)) {
      d = new Date(Date.UTC(1899, 11, 30) + value * 86400000);
    }

    return d instanceof Date && !isNaN(d.getTime()) ? 
      d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : '';
  }

  function updateSummary(data) {
    let delivered = 0, cancelled = 0, inProgress = 0;

    data.forEach(row => {
      const ordered = Number(row["Quantity Ordered"] || 0);
      const deliveredQty = Number(row["Quantity Delivered"] || 0);
      const cancelledQty = Number(row["Quantity Cancelled"] || 0);

      if (cancelledQty > 0) cancelled++;
      else if (deliveredQty === ordered && ordered > 0) delivered++;
      else if (deliveredQty !== ordered && cancelledQty === 0) inProgress++;
    });

    document.getElementById('totalOrders').textContent = data.length;
    document.getElementById('deliveredOrders').textContent = delivered;
    document.getElementById('cancelledOrders').textContent = cancelled;
    document.getElementById('partialOrders').textContent = inProgress;
  }

function filterTable() {
  console.log('filterTable called');

  const searchInput = document.getElementById('searchInput');
  const statusSelect = document.getElementById('statusFilter');

  const search = (searchInput?.value || '').toLowerCase();
  const statusFilter = (statusSelect?.value || '').toLowerCase();

  console.log('Search:', search, 'Status filter:', statusFilter);

  const filtered = fullData.filter(row => {
    const customerRaw = row["Customer"] ?? row["Supplier"] ?? '';
    const productRaw = row["Product"] ?? row["Description"] ?? '';

    const customer = String(customerRaw).toLowerCase();
    const product = String(productRaw).toLowerCase();

    let status = '';
    try {
      status = determineStatus(row).toLowerCase();
    } catch (err) {
      console.warn("Invalid row during status determination:", row, err);
    }

    return (customer.includes(search) || product.includes(search)) &&
           (!statusFilter || status === statusFilter);
  });

  console.log('Filtered data count:', filtered.length);

  populateTable(filtered);
  updateSummary(filtered);
}


  

  function submitRemarks() {
    const newText = document.getElementById('newRemarks').value.trim();
    const orderId = currentEditingOrderId;

    if (!orderId || !currentUserId) return;

    firestore.collection('orders').doc(currentUserId).collection('userOrders').doc(orderId)
      .update({ REMARKS: newText })
      .then(() => {
        // Update local data and UI
        const row = fullData.find(r => r["Number"] == orderId);
        if (row) row["REMARKS"] = newText;
        populateTable(fullData);
        console.log('Remarks updated in Firestore');
      })
      .catch(err => console.error('Error updating remarks:', err));

    const modalEl = document.getElementById('editModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
  }







function renderCharts(data) {
  const currency = document.getElementById("currencySelector")?.value || "ALL";
  const sortType = document.getElementById("orderSortSelector")?.value || "month";

  const monthlySales = {};
  const monthlyOrders = {};

  // Extract and calculate data
  data.forEach(order => {
    const orderDate = order["Order Date"];
    const orderCurrency = order["Currency"] || "PHP";
    const unitPrice = parseFloat(order["Unit Price"] || 0);
    const qty = parseFloat(order["Quantity Ordered"] || 0);

    if (!orderDate || isNaN(unitPrice) || isNaN(qty)) return;

    const date = new Date(orderDate);
    const monthYear = date.toLocaleString("default", { month: "short", year: "numeric" });

    if (currency === "ALL" || currency === orderCurrency) {
      monthlySales[monthYear] = (monthlySales[monthYear] || 0) + qty * unitPrice;
    }

    monthlyOrders[monthYear] = (monthlyOrders[monthYear] || 0) + 1;
  });

  let labels = [...new Set([...Object.keys(monthlySales), ...Object.keys(monthlyOrders)])];

  // Store globally for sorting
  globalOrderStats = labels.map(label => ({
    month: label,
    value: monthlyOrders[label] || 0
  }));

  // Sort based on selected sort type
if (sortType === "asc") {
  globalOrderStats.sort((a, b) => a.value - b.value);
} else if (sortType === "desc") {
  globalOrderStats.sort((a, b) => b.value - a.value);
} else {
  globalOrderStats.sort((a, b) => {
    const [monthA, yearA] = a.month.split(" ");
    const [monthB, yearB] = b.month.split(" ");

    const yearDiff = parseInt(yearA) - parseInt(yearB);
    if (yearDiff !== 0) return yearDiff;

    return monthOrderIndex[monthA] - monthOrderIndex[monthB]; // ‚úÖ safer, faster
  });
}


  const sortedLabels = globalOrderStats.map(d => d.month);
  const salesData = sortedLabels.map(month => monthlySales[month] || 0);
  const ordersData = globalOrderStats.map(d => d.value);

  // üí∏ Monthly Sales Chart
  const salesCtx = document.getElementById("chartCanvas").getContext("2d");
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(salesCtx, {
    type: 'line',
    data: {
      labels: sortedLabels,
      datasets: [{
        label: `Monthly Sales (${currency})`,
        data: salesData,
        borderColor: "#007aff",
        backgroundColor: "rgba(0,122,255,0.1)",
        fill: true,
        tension: 0.4,
        borderWidth: 2.5,
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: ctx => `${currency} ${ctx.parsed.y.toFixed(2)}`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: val => `${currency} ${val.toLocaleString()}`
          }
        }
      }
    }
  });

  // üßæ Orders Issued Chart
  const ordersCtx = document.getElementById("ordersIssuedChart").getContext("2d");
  if (ordersChartInstance) ordersChartInstance.destroy();
  ordersChartInstance = new Chart(ordersCtx, {
    type: 'bar',
    data: {
      labels: sortedLabels,
      datasets: [{
        label: "Orders Issued",
        data: ordersData,
        backgroundColor: "#34c759",
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.parsed.y} Orders`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
}





document.getElementById('currencySelector')?.addEventListener('change', () => {
  renderCharts(fullData);
});

document.getElementById("orderSortSelector")?.addEventListener("change", () => {
  renderCharts(fullData);
});









</script>





</body>
</html>
